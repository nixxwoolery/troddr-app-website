<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TRODDR — On the Radar</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/images/troddr_logo.png">
  <link rel="icon" type="image/png" href="/images/troddr_logo.png">
  <link rel="apple-touch-icon" href="/images/troddr_logo.png">
  
  <style>
    :root{
      --brand:#0077cc;
      --bg:#ffffff;
      --fg:#0b1220;
      --muted:#6b7280;
      --card:#f8fafc;
      --line:#e5e7eb;
      --radius:14px;
      --gap:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    a{text-decoration:none;color:inherit}

    .wrap{max-width:1100px;margin:0 auto;padding:0 20px 20px}

    /* Hero banner */
    .hero-banner{
      width:100vw;
      margin-left:calc(50% - 50vw);
      margin-right:calc(50% - 50vw);
      height:300px;
      background:#f2f6fb;
      position:relative;
      margin-bottom:24px;
    }
    .hero-banner img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .hero-badge{
      position:absolute;
      top:20px;
      left:20px;
      padding:10px 16px;
      border-radius:10px;
      background:rgba(255,255,255,0.95);
      font-weight:700;
      font-size:14px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
      color:#fff;
    }

    /* Title section */
    .title-section{
      margin-bottom:24px;
    }
    .special-badge{
      display:inline-block;
      padding:6px 12px;
      border-radius:6px;
      font-size:12px;
      font-weight:600;
      color:#fff;
      margin-bottom:12px;
    }
    .special-title{
      font-size:clamp(24px,3.5vw,36px);
      font-weight:700;
      margin:0 0 8px;
      letter-spacing:-0.02em;
      line-height:1.2;
    }
    .special-dates{
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      font-size:15px;
      margin-bottom:6px;
    }
    .special-time{
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      font-size:15px;
    }
    
    /* Main card */
    .special-card{
      background:var(--card);
      border-radius:var(--radius);
      padding:24px;
      box-shadow:0 1px 3px rgba(0,0,0,0.05);
      margin-bottom:20px;
    }
    .special-description{
      font-size:16px;
      line-height:1.6;
      color:#374151;
      margin-bottom:20px;
    }

    /* Discount highlight */
    .discount-box{
      background:#e8f5e9;
      border:2px dashed #2e7d32;
      border-radius:12px;
      padding:20px;
      text-align:center;
      margin:20px 0;
    }
    .discount-amount{
      font-size:32px;
      font-weight:700;
      color:#2e7d32;
      margin:0;
    }
    .discount-label{
      font-size:14px;
      color:#2e7d32;
      font-weight:500;
    }

    /* Place card */
    .place-section{
      background:var(--card);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:0 1px 3px rgba(0,0,0,0.05);
      margin-bottom:20px;
    }
    .place-header{
      padding:20px 24px 16px;
      background:#f8fafc;
      border-bottom:1px solid var(--line);
    }
    .place-header-title{
      font-size:14px;
      font-weight:600;
      color:#666;
      text-transform:uppercase;
      letter-spacing:0.05em;
    }
    .place-content{
      padding:24px;
      display:flex;
      gap:20px;
    }
    .place-image{
      width:120px;
      height:120px;
      border-radius:12px;
      object-fit:cover;
      flex-shrink:0;
    }
    .place-info{
      flex:1;
      min-width:0;
    }
    .place-name{
      font-size:20px;
      font-weight:600;
      color:#0b1220;
      margin:0 0 8px;
    }
    .place-location{
      display:flex;
      align-items:center;
      gap:6px;
      color:var(--brand);
      font-size:14px;
      margin-bottom:12px;
    }
    .place-category{
      display:inline-block;
      background:#e6f0ff;
      color:var(--brand);
      padding:4px 10px;
      border-radius:6px;
      font-size:12px;
      font-weight:600;
    }

    /* Action buttons */
    .actions-row{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      margin-top:24px;
    }
    .action-btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:12px 20px;
      border-radius:10px;
      font-weight:600;
      font-size:14px;
      transition:all 0.2s ease;
      cursor:pointer;
      border:none;
    }
    .action-btn-primary{
      background:var(--brand);
      color:#fff;
    }
    .action-btn-primary:hover{
      background:#005bb5;
    }
    .action-btn-secondary{
      background:#e6f0ff;
      color:var(--brand);
    }
    .action-btn-secondary:hover{
      background:#d4e5ff;
    }

    /* Details */
    .details-section{
      margin-top:24px;
    }
    .detail-row{
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding:12px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .detail-row:last-child{
      border:none;
    }
    .detail-icon{
      width:32px;
      height:32px;
      background:#e6f0ff;
      color:var(--brand);
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
    }
    .detail-content{
      flex:1;
    }
    .detail-label{
      font-size:12px;
      color:#666;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.05em;
      margin-bottom:4px;
    }
    .detail-value{
      font-size:15px;
      color:#0b1220;
    }

    /* Expiring soon badge */
    .expiring-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:#fff4e5;
      color:#ef6c00;
      padding:6px 12px;
      border-radius:8px;
      font-size:13px;
      font-weight:600;
      margin-top:12px;
    }

    /* Skeleton loading */
    .skeleton{
      background:linear-gradient(90deg,#f2f4f7,#e9edf2,#f2f4f7);
      background-size:200% 100%;
      animation:shimmer 1.2s infinite;
      color:transparent !important;
    }
    @keyframes shimmer{
      0%{background-position:200% 0}
      100%{background-position:-200% 0}
    }
    .skel-line{
      height:16px;
      border-radius:8px;
      margin:8px 0;
    }
    .skel-hero{
      width:100%;
      height:300px;
      background:#f2f4f7;
    }

    /* Responsive */
    @media (max-width:768px){
      .place-content{
        flex-direction:column;
      }
      .place-image{
        width:100%;
        height:200px;
      }
      .hero-banner{
        height:240px;
      }
    }

    /* Color mapping for special types */
    .type-partnership{background-color:#6A1B9A}
    .type-local_discount{background-color:#2E7D32}
    .type-seasonal{background-color:#EF6C00}
    .type-general{background-color:#1B5E20}
  </style>

  <script>
    window.env = window.env || {
      SUPABASE_URL: 'https://rprpwudhplodaqmmwqkf.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwcnB3dWRocGxvZGFxbW13cWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAyODcyODksImV4cCI6MjA2NTg2MzI4OX0.lNL6YZQqZgbsQRJyRAXpaWMC4LxncvPPyXNP1qopTFk'
    };
  </script>
</head>
<body>
  <header class="header" role="banner">
    <div class="navbar">
      <a href="index.html" class="logo" aria-label="TRODDR - Home">troddr</a>
      <button class="mobile-menu-btn"
              aria-controls="primary-navigation"
              aria-expanded="false"
              aria-label="Open menu">
        <span aria-hidden="true">☰</span>
      </button>
      <div class="nav-links" id="primary-navigation" role="navigation">
        <button class="nav-close-btn" aria-controls="primary-navigation" aria-label="Close menu">×</button>
        <a href="about.html" class="nav-item">About</a>
        <a href="#features" class="nav-item">Features</a>
        <a href="contact.html" class="nav-item">Contact</a>
        <a href="#waitlist" class="nav-cta">Join Waitlist</a>
      </div>
    </div>
  </header>

  <!-- Hero banner -->
  <div class="hero-banner" id="hero-banner">
    <div class="hero-badge" id="hero-badge"></div>
  </div>

  <div class="wrap">
    <!-- Title section -->
    <div class="title-section">
      <div class="special-badge" id="special-badge"></div>
      <h1 class="special-title" id="special-title">Loading...</h1>
      <div class="special-dates" id="special-dates"></div>
      <div class="special-time" id="special-time" style="display:none"></div>
    </div>

    <!-- Main card -->
    <div class="special-card">
      <p class="special-description" id="special-description"></p>
      
      <div class="discount-box" id="discount-box" style="display:none">
        <p class="discount-amount" id="discount-amount"></p>
        <p class="discount-label">Special Offer</p>
      </div>

      <div class="details-section" id="details-section"></div>
      
      <div id="expiring-badge" class="expiring-badge" style="display:none">
        <i class="fas fa-clock"></i>
        <span>Expiring soon!</span>
      </div>
    </div>

    <!-- Place section -->
    <div class="place-section" id="place-section" style="display:none">
      <div class="place-header">
        <h3 class="place-header-title">Available At</h3>
      </div>
      <div class="place-content">
        <img class="place-image" id="place-image" alt="">
        <div class="place-info">
          <h3 class="place-name" id="place-name"></h3>
          <div class="place-location" id="place-location">
            <i class="fas fa-map-marker-alt"></i>
            <span id="place-address"></span>
          </div>
          <span class="place-category" id="place-category"></span>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="actions-row">
      <a class="action-btn action-btn-primary" id="view-place" href="#" style="display:none">
        <i class="fas fa-store"></i>
        View Place
      </a>
      <button class="action-btn action-btn-secondary" id="share-btn">
        <i class="fas fa-share-alt"></i>
        Share Special
      </button>
      <a class="action-btn action-btn-secondary" id="open-app" href="#">
        <i class="fas fa-mobile-alt"></i>
        Open in App
      </a>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="section-container">
      <div class="footer-content">
        <div class="footer-section">
          <h3>TRODDR</h3>
          <p>Your ultimate Jamaican travel companion. Discover authentic experiences, plan perfect trips, and explore the island like a local.</p>
        </div>
        <div class="footer-section">
          <h3>Company</h3>
          <div class="footer-links">
            <a href="about.html">About Us</a>
            <a href="#features">Features</a>
            <a href="contact.html">Contact</a>
            <a href="#demo">Join Waitlist</a>
          </div>
        </div>
        <div class="footer-section">
          <h3>Support</h3>
          <div class="footer-links">
            <a href="#">Help Center</a>
            <a href="contact.html">Contact Us</a>
            <a href="privacy.html">Privacy Policy</a>
            <a href="terms.html">Terms of Service</a>
          </div>
        </div>
      </div>
      <div class="footer-bottom">
        <p>© 2025 TRODDR. Made with ❤️ in Jamaica. Explore authentic experiences across the Caribbean.</p>
      </div>
    </div>
  </footer>

  <script>
    // Mobile menu
    (function(){
      const menuBtn  = document.querySelector('.mobile-menu-btn');
      const navLinks = document.querySelector('.nav-links');
      const closeBtn = document.querySelector('.nav-close-btn');
      if (!menuBtn || !navLinks) return;
      
      menuBtn.addEventListener('click', function(){
        const isOpen = navLinks.classList.toggle('mobile-open');
        this.classList.toggle('active', isOpen);
        this.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        document.body.classList.toggle('menu-open', isOpen);
      });
      
      navLinks.addEventListener('click', function(e){
        const link = e.target.closest('a');
        if (!link) return;
        navLinks.classList.remove('mobile-open');
        menuBtn.classList.remove('active');
        menuBtn.setAttribute('aria-expanded', 'false');
        document.body.classList.remove('menu-open');
      });
      
      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          navLinks.classList.remove('mobile-open');
          menuBtn.classList.remove('active');
          menuBtn.setAttribute('aria-expanded', 'false');
          document.body.classList.remove('menu-open');
        });
      }
      
      document.addEventListener('keydown', function(e){
        if (e.key === 'Escape') {
          navLinks.classList.remove('mobile-open');
          menuBtn.classList.remove('active');
          menuBtn.setAttribute('aria-expanded', 'false');
          document.body.classList.remove('menu-open');
        }
      });
    })();
  </script>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL = window.env.SUPABASE_URL.trim();
    const SUPABASE_ANON_KEY = window.env.SUPABASE_ANON_KEY.trim();
    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } });

    const params = new URLSearchParams(location.search);
    const pathMatch = location.pathname.match(/\/specials\/([^\/?#]+)/i);
    const specialId = params.get('id') || (pathMatch ? decodeURIComponent(pathMatch[1]) : '');

    const $ = (sel) => document.querySelector(sel);
    const set = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text ?? ''; };

    // Analytics
    function track(eventName, params = {}){
      try {
        if (typeof window.gtag === 'function') {
          window.gtag('event', eventName, params);
        }
        console.debug('[track]', eventName, params);
      } catch {}
    }

    // Special type mappings
    const SPECIAL_TYPE_COLORS = {
      partnership: '#6A1B9A',
      local_discount: '#2E7D32',
      seasonal: '#EF6C00',
      general: '#1B5E20',
    };

    const SPECIAL_TYPE_LABELS = {
      partnership: 'Partnership',
      local_discount: 'Local Discount',
      seasonal: 'Seasonal',
      general: 'Special Offer',
    };

    // Date formatting
    const formatDate = (dateString) => {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
      });
    };

    const formatTime = (timeString) => {
      const [hours, minutes] = timeString.split(':').map(Number);
      const period = hours >= 12 ? 'PM' : 'AM';
      const displayHours = hours % 12 || 12;
      return `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
    };

    const formatTimeRange = (startTime, endTime) => {
      if (!startTime && !endTime) return null;
      if (startTime && endTime) {
        return `${formatTime(startTime)} - ${formatTime(endTime)}`;
      }
      if (startTime) {
        return `Starting at ${formatTime(startTime)}`;
      }
      if (endTime) {
        return `Until ${formatTime(endTime)}`;
      }
      return null;
    };

    const isExpiringSoon = (endDate) => {
      const end = new Date(endDate);
      const now = new Date();
      const daysUntilExpiry = Math.ceil((end.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
      return daysUntilExpiry <= 7 && daysUntilExpiry > 0;
    };

    // Meta tags
    function upsertMeta(attr, name, content){
      let sel = `${attr}="${name}"`;
      let el = document.head.querySelector(`meta[${sel}]`);
      if (!el){ el = document.createElement('meta'); el.setAttribute(attr, name); document.head.appendChild(el); }
      el.setAttribute('content', content);
    }

    function injectOG(special){
      try{
        const title = `${special.title} — TRODDR`;
        const desc = special.description || `Check out this special offer on TRODDR!`;
        const img = special.place?.image ? 
          (Array.isArray(special.place.image) ? special.place.image[0] : special.place.image) : 
          '/images/og-default.jpg';
        const url = `${window.location.origin}/specials/${specialId}`;

        document.title = title;
        upsertMeta('property','og:title', title);
        upsertMeta('property','og:description', desc);
        upsertMeta('property','og:type', 'website');
        upsertMeta('property','og:url', url);
        upsertMeta('property','og:image', img);
        upsertMeta('name','twitter:card','summary_large_image');
        upsertMeta('name','twitter:title', title);
        upsertMeta('name','twitter:description', desc);
        upsertMeta('name','twitter:image', img);
        upsertMeta('name', 'description', desc);

        let link = document.head.querySelector('link[rel="canonical"]');
        if (!link){
          link = document.createElement('link');
          link.setAttribute('rel','canonical');
          document.head.appendChild(link);
        }
        link.setAttribute('href', url);
      }catch(e){}
    }

    // Show skeleton
    function showSkeleton(){
      $('#special-title').classList.add('skeleton');
      $('#special-description').innerHTML = '<div class="skel-line" style="width:80%"></div><div class="skel-line" style="width:90%"></div><div class="skel-line" style="width:60%"></div>';
      $('#hero-banner').classList.add('skel-hero');
    }

    function hideSkeleton(){
      $('#special-title').classList.remove('skeleton');
      $('#hero-banner').classList.remove('skel-hero');
    }

    // Render details
    function renderDetails(special){
      const details = [];
      
      if (special.partner_name) {
        details.push({
          icon: 'fa-handshake',
          label: 'Partner',
          value: special.partner_name
        });
      }

      if (special.recurring_days && special.recurring_days.length > 0) {
        const startDate = new Date(special.start_date);
        const endDate = new Date(special.end_date);
        const isSingleDay = (
          startDate.getFullYear() === endDate.getFullYear() &&
          startDate.getMonth() === endDate.getMonth() &&
          startDate.getDate() === endDate.getDate()
        );
        
        if (!isSingleDay) {
          details.push({
            icon: 'fa-redo',
            label: 'Available Days',
            value: special.recurring_days.map(day => 
              day.charAt(0).toUpperCase() + day.slice(1)
            ).join(', ')
          });
        }
      }

      if (details.length === 0) return;

      const html = details.map(detail => `
        <div class="detail-row">
          <div class="detail-icon">
            <i class="fas ${detail.icon}"></i>
          </div>
          <div class="detail-content">
            <div class="detail-label">${detail.label}</div>
            <div class="detail-value">${detail.value}</div>
          </div>
        </div>
      `).join('');

      $('#details-section').innerHTML = html;
    }

    // Share functionality
    async function shareSpecial(special){
      const shareData = {
        title: special.title,
        text: special.description || `Check out this special offer${special.place ? ' at ' + special.place.name : ''}!`,
        url: window.location.href
      };

      try {
        if (navigator.share) {
          await navigator.share(shareData);
          track('special_shared', { method: 'web_share', special_id: specialId });
        } else {
          // Fallback - copy to clipboard
          const text = `${shareData.title}\n${shareData.text}\n${shareData.url}`;
          await navigator.clipboard.writeText(text);
          alert('Link copied to clipboard!');
          track('special_shared', { method: 'copy_link', special_id: specialId });
        }
      } catch (err) {
        console.error('Error sharing:', err);
      }
    }

    // Main function
    async function main(){
      if (!specialId){
        set('special-title', 'Special not found');
        set('special-description', 'Please check the URL and try again.');
        return;
      }

      showSkeleton();
      track('special_page_viewed', { special_id: specialId });

      // Fetch special
      const { data: special, error } = await supa
        .from('specials')
        .select(`
          id,
          title,
          description,
          special_type,
          partner_name,
          start_date,
          end_date,
          start_time,
          end_time,
          recurring_days,
          priority,
          discount_percentage,
          discount_amount,
          place:places!specials_place_id_fkey(
            id,
            name,
            slug,
            town,
            parish,
            image,
            category,
            address
          )
        `)
        .eq('id', specialId)
        .eq('active', true)
        .single();

      if (error || !special) {
        set('special-title', 'Special not found');
        set('special-description', 'This special offer may have expired or been removed.');
        hideSkeleton();
        return;
      }

      // Set hero image and badge
      const place = special.place;
      if (place?.image) {
        const imageUrl = Array.isArray(place.image) ? place.image[0] : place.image;
        $('#hero-banner').innerHTML = `<img src="${imageUrl}" alt="" style="width:100%;height:100%;object-fit:cover;">`;
      }

      // Hero badge
      const badgeColor = SPECIAL_TYPE_COLORS[special.special_type];
      const badgeLabel = SPECIAL_TYPE_LABELS[special.special_type];
      $('#hero-badge').textContent = badgeLabel;
      $('#hero-badge').style.backgroundColor = badgeColor;

      // Special badge
      $('#special-badge').textContent = badgeLabel;
      $('#special-badge').className = `special-badge type-${special.special_type}`;

      // Title and description
      set('special-title', special.title);
      set('special-description', special.description || 'Enjoy this special offer!');

      // Dates
      const datesHtml = `
        <i class="fas fa-calendar"></i>
        <span>${formatDate(special.start_date) === formatDate(special.end_date)
          ? formatDate(special.start_date)
          : `${formatDate(special.start_date)} - ${formatDate(special.end_date)}`}</span>
      `;
      $('#special-dates').innerHTML = datesHtml;

      // Times
      const timeRange = formatTimeRange(special.start_time, special.end_time);
      if (timeRange) {
        $('#special-time').innerHTML = `
          <i class="fas fa-clock"></i>
          <span>${timeRange}</span>
        `;
        $('#special-time').style.display = 'flex';
      }

      // Discount box
      if (special.discount_percentage || special.discount_amount) {
        $('#discount-box').style.display = 'block';
        if (special.discount_percentage) {
          set('discount-amount', `${special.discount_percentage}% OFF`);
        } else {
          set('discount-amount', `$${special.discount_amount} OFF`);
        }
      }

      // Expiring soon
      if (isExpiringSoon(special.end_date)) {
        $('#expiring-badge').style.display = 'inline-flex';
      }

      // Details
      renderDetails(special);

      // Place section
      if (place) {
        $('#place-section').style.display = 'block';
        
        const imageUrl = place.image ? 
          (Array.isArray(place.image) ? place.image[0] : place.image) :
          null;
        
        if (imageUrl) {
          $('#place-image').src = imageUrl;
          $('#place-image').alt = place.name;
        } else {
          $('#place-image').style.display = 'none';
        }
        
        set('place-name', place.name);
        set('place-address', [place.address, place.town, place.parish].filter(Boolean).join(', '));
        
        // Category
        const categoryEmojis = {
          eat: '🍽️',
          stay: '🛏️',
          play: '🎯'
        };
        const categoryText = place.category ? 
          `${categoryEmojis[place.category] || ''} ${place.category.charAt(0).toUpperCase() + place.category.slice(1)}` : 
          '';
        set('place-category', categoryText);

        // View place button
        if (place.slug) {
          const viewBtn = $('#view-place');
          viewBtn.href = `/listings/${place.slug}`;
          viewBtn.style.display = 'inline-flex';
          viewBtn.addEventListener('click', () => {
            track('view_place_from_special', { 
              special_id: specialId,
              place_slug: place.slug 
            });
          });
        }
      }

      // Share button
      $('#share-btn').addEventListener('click', (e) => {
        e.preventDefault();
        shareSpecial(special);
      });

      // Open in app
      const openAppLink = $('#open-app');
      openAppLink.href = `troddr://special/${encodeURIComponent(specialId)}`;
      openAppLink.addEventListener('click', (e) => {
        e.preventDefault();
        track('open_in_app', { special_id: specialId });
        window.location = openAppLink.href;
        setTimeout(() => {
          window.location = 'https://apps.apple.com/app/idYOUR_APP_ID';
        }, 1500);
      });

      injectOG(special);
      hideSkeleton();
    }

    main();
  </script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TRODDR ‚Äî Special Offer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/images/troddr_logo.png">
  <link rel="icon" type="image/png" href="/images/troddr_logo.png">
  <link rel="apple-touch-icon" href="/images/troddr_logo.png">
  
  <style>
    :root{
      --brand:#0077cc;
      --bg:#ffffff;
      --fg:#0b1220;
      --muted:#6b7280;
      --card:#f8fafc;
      --line:#e5e7eb;
      --radius:14px;
      --gap:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    a{text-decoration:none;color:inherit}

    .wrap{max-width:1100px;margin:0 auto;padding:20px}

    /* Title Row */
    header.page{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin:20px 0 12px;
    }
    .titleBlock{min-width:0}
    .title{
      font-size:clamp(22px,3.2vw,36px);
      font-weight:600;
      margin:0 0 6px;
      letter-spacing:-0.01em;
      line-height:1.1;
    }
    .sub{color:var(--muted);font-size:14px}
    .cta{
      display:inline-flex;
      align-items:center;
      gap:10px;
      background:var(--brand);
      color:#fff;
      border-radius:12px;
      padding:10px 14px;
      font-weight:700;
    }

    /* Special Type Badge */
    .special-type-badge{
      display:inline-block;
      padding:6px 12px;
      border-radius:6px;
      font-size:12px;
      font-weight:600;
      color:#fff;
      margin-bottom:12px;
    }

    /* Cards */
    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:24px;
      box-shadow:0 1px 3px rgba(0,0,0,0.05);
      margin-bottom:20px;
    }
    .card.narrow{max-width:760px;margin:16px 0}

    /* Info list */
    .infoRow{
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding:10px 0;
      border-bottom:none;
      position:relative;
    }
    .infoRow::after{
      content:"";
      position:absolute;
      left:44px;
      right:0;
      bottom:0;
      height:1px;
      background:linear-gradient(90deg,#e9edf2,transparent);
    }
    .infoRow:last-child::after{display:none}
    .icon{
      width:32px;
      height:32px;
      border-radius:16px;
      background:#e8f3ff;
      color:var(--brand);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      flex-shrink:0;
    }
    .kv{flex:1}
    .kv .k{
      font-size:13px;
      color:#111;
      font-weight:500;
      margin-bottom:2px;
    }
    .kv .v{
      font-size:14px;
      color:#555;
      font-weight:400;
    }

    /* Discount highlight */
    .discount-box{
      background:#e8f5e9;
      border:2px dashed #2e7d32;
      border-radius:12px;
      padding:20px;
      text-align:center;
      margin:20px 0;
    }
    .discount-amount{
      font-size:32px;
      font-weight:700;
      color:#2e7d32;
      margin:0;
    }
    .discount-label{
      font-size:14px;
      color:#2e7d32;
      font-weight:500;
    }

    /* Action buttons */
    .action-bar{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      margin-top:20px;
    }
    .action-btn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:#007aff;
      color:#fff !important;
      font-weight:600;
      padding:10px 16px;
      border-radius:8px;
      text-decoration:none;
      cursor:pointer;
      box-shadow:0 2px 4px rgba(0,0,0,.15);
      transition:background 0.2s ease,transform 0.1s ease;
    }
    .action-btn:hover{background:#005bb5}
    .action-btn:active{transform:scale(0.97)}
    .action-btn i{font-size:14px}

    /* Place section */
    .place-section{
      background:var(--card);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:0 1px 3px rgba(0,0,0,0.05);
      margin-bottom:20px;
    }
    .place-header{
      padding:20px 24px 16px;
      background:#f8fafc;
      border-bottom:1px solid var(--line);
    }
    .place-header-title{
      font-size:14px;
      font-weight:600;
      color:#666;
      text-transform:uppercase;
      letter-spacing:0.05em;
    }
    .place-content{
      padding:24px;
      display:flex;
      gap:20px;
    }
    .place-image{
      width:120px;
      height:120px;
      border-radius:12px;
      object-fit:cover;
      flex-shrink:0;
    }
    .place-info{
      flex:1;
      min-width:0;
    }
    .place-name{
      font-size:20px;
      font-weight:600;
      color:#0b1220;
      margin:0 0 8px;
    }
    .place-location{
      display:flex;
      align-items:center;
      gap:6px;
      color:var(--brand);
      font-size:14px;
      margin-bottom:12px;
    }
    .place-category{
      display:inline-block;
      background:#e6f0ff;
      color:var(--brand);
      padding:4px 10px;
      border-radius:6px;
      font-size:12px;
      font-weight:600;
    }

    /* Expiring badge */
    .expiring-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:#fff4e5;
      color:#ef6c00;
      padding:6px 12px;
      border-radius:8px;
      font-size:13px;
      font-weight:600;
      margin-top:12px;
    }

    /* Responsive */
    @media (max-width:768px){
      .place-content{
        flex-direction:column;
      }
      .place-image{
        width:100%;
        height:200px;
      }
    }

    /* Color mapping for special types */
    .type-partnership{background-color:#6A1B9A}
    .type-local_discount{background-color:#2E7D32}
    .type-seasonal{background-color:#EF6C00}
    .type-general{background-color:#1B5E20}
  </style>

  <script>
    window.env = window.env || {
      SUPABASE_URL: 'https://rprpwudhplodaqmmwqkf.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwcnB3dWRocGxvZGFxbW13cWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAyODcyODksImV4cCI6MjA2NTg2MzI4OX0.lNL6YZQqZgbsQRJyRAXpaWMC4LxncvPPyXNP1qopTFk'
    };
  </script>
</head>
<body>
  <header class="header" role="banner">
    <div class="navbar">
      <a href="/" class="logo" aria-label="TRODDR - Home">troddr</a>
      <button class="mobile-menu-btn" aria-controls="primary-navigation" aria-expanded="false" aria-label="Open menu">
        <span aria-hidden="true">‚ò∞</span>
      </button>
      <div class="nav-links" id="primary-navigation" role="navigation">
        <button class="nav-close-btn" aria-controls="primary-navigation" aria-label="Close menu">√ó</button>
        <a href="/about.html" class="nav-item">About</a>
        <a href="/#features" class="nav-item">Features</a>
        <a href="/contact.html" class="nav-item">Contact</a>
        <a href="/#waitlist" class="nav-cta">Join Waitlist</a>
      </div>
    </div>
  </header>

  <div class="wrap">
    <!-- Title section -->
    <header class="page">
      <div class="titleBlock">
        <div class="special-type-badge" id="special-type-badge" style="display:none"></div>
        <h1 class="title" id="special-title">Loading...</h1>
        <div class="sub" id="special-dates"></div>
      </div>
      <a class="cta" id="open-in-app" href="#">Open in App</a>
    </header>

    <!-- Main content -->
    <div class="card narrow">
      <p id="special-description"></p>
      
      <!-- Discount box -->
      <div class="discount-box" id="discount-box" style="display:none">
        <p class="discount-amount" id="discount-amount"></p>
        <p class="discount-label">Special Offer</p>
      </div>

      <!-- Info list -->
      <div id="infoList"></div>
      
      <!-- Expiring badge -->
      <div id="expiring-badge" class="expiring-badge" style="display:none">
        <i class="fas fa-clock"></i>
        <span>Expiring soon!</span>
      </div>
    </div>

    <!-- Place section -->
    <div class="place-section" id="place-section" style="display:none">
      <div class="place-header">
        <h3 class="place-header-title">Available At</h3>
      </div>
      <div class="place-content">
        <img class="place-image" id="place-image" alt="">
        <div class="place-info">
          <h3 class="place-name" id="place-name"></h3>
          <div class="place-location">
            <i class="fas fa-map-marker-alt"></i>
            <span id="place-address"></span>
          </div>
          <span class="place-category" id="place-category"></span>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="action-bar">
      <a class="action-btn" id="view-place" href="#" style="display:none">
        <i class="fas fa-store"></i> View Place
      </a>
      <button class="action-btn" id="share-btn">
        <i class="fas fa-share-alt"></i> Share
      </button>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="section-container">
      <div class="footer-content">
        <div class="footer-section">
          <h3>TRODDR</h3>
          <p>Your ultimate Jamaican travel companion. Discover authentic experiences, plan perfect trips, and explore the island like a local.</p>
        </div>
        <div class="footer-section">
          <h3>Company</h3>
          <div class="footer-links">
            <a href="about.html">About Us</a>
            <a href="#features">Features</a>
            <a href="contact.html">Contact</a>
            <a href="#demo">Join Waitlist</a>
          </div>
        </div>
        <div class="footer-section">
          <h3>Support</h3>
          <div class="footer-links">
            <a href="#">Help Center</a>
            <a href="contact.html">Contact Us</a>
            <a href="privacy.html">Privacy Policy</a>
            <a href="terms.html">Terms of Service</a>
          </div>
        </div>
      </div>
      <div class="footer-bottom">
        <p>¬© 2025 TRODDR. Made with ‚ù§Ô∏è in Jamaica. Explore authentic experiences across the Caribbean.</p>
      </div>
    </div>
  </footer>

  <script>
    // Mobile menu
    (function(){
      const menuBtn = document.querySelector('.mobile-menu-btn');
      const navLinks = document.querySelector('.nav-links');
      const closeBtn = document.querySelector('.nav-close-btn');
      if (!menuBtn || !navLinks) return;
      
      menuBtn.addEventListener('click', function(){
        const isOpen = navLinks.classList.toggle('mobile-open');
        this.classList.toggle('active', isOpen);
        this.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        document.body.classList.toggle('menu-open', isOpen);
      });
      
      navLinks.addEventListener('click', function(e){
        const link = e.target.closest('a');
        if (!link) return;
        navLinks.classList.remove('mobile-open');
        menuBtn.classList.remove('active');
        menuBtn.setAttribute('aria-expanded', 'false');
        document.body.classList.remove('menu-open');
      });
      
      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          navLinks.classList.remove('mobile-open');
          menuBtn.classList.remove('active');
          menuBtn.setAttribute('aria-expanded', 'false');
          document.body.classList.remove('menu-open');
        });
      }
      
      document.addEventListener('keydown', function(e){
        if (e.key === 'Escape') {
          navLinks.classList.remove('mobile-open');
          menuBtn.classList.remove('active');
          menuBtn.setAttribute('aria-expanded', 'false');
          document.body.classList.remove('menu-open');
        }
      });
    })();
  </script>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL = window.env.SUPABASE_URL.trim();
    const SUPABASE_ANON_KEY = window.env.SUPABASE_ANON_KEY.trim();
    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } });

    const params = new URLSearchParams(location.search);
    const pathMatch = location.pathname.match(/\/specials\/([^\/?#]+)/i);
    const slug = params.get('special_slug') || (pathMatch ? decodeURIComponent(pathMatch[1]) : '');

    const $ = (sel) => document.querySelector(sel);
    const set = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text ?? ''; };

    console.log('=== SPECIALS PAGE DEBUG ===');
    console.log('URL:', window.location.href);
    console.log('Slug extracted:', slug);

    // Analytics
    function track(eventName, params = {}){
      try {
        if (typeof window.gtag === 'function') {
          window.gtag('event', eventName, params);
        }
        console.debug('[track]', eventName, params);
      } catch {}
    }

    // Special type mappings
    const SPECIAL_TYPE_COLORS = {
      partnership: '#6A1B9A',
      local_discount: '#2E7D32',
      seasonal: '#EF6C00',
      general: '#1B5E20',
    };

    const SPECIAL_TYPE_LABELS = {
      partnership: 'Partnership',
      local_discount: 'Local Discount',
      seasonal: 'Seasonal',
      general: 'Special Offer',
    };

    // Date formatting
    const formatDate = (dateString) => {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
      });
    };

    const formatTime = (timeString) => {
      if (!timeString) return '';
      const [hours, minutes] = timeString.split(':').map(Number);
      const period = hours >= 12 ? 'PM' : 'AM';
      const displayHours = hours % 12 || 12;
      return `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
    };

    const formatTimeRange = (startTime, endTime) => {
      if (!startTime && !endTime) return null;
      if (startTime && endTime) {
        return `${formatTime(startTime)} - ${formatTime(endTime)}`;
      }
      if (startTime) return `Starting at ${formatTime(startTime)}`;
      if (endTime) return `Until ${formatTime(endTime)}`;
      return null;
    };

    const isExpiringSoon = (endDate) => {
      const end = new Date(endDate);
      const now = new Date();
      const daysUntilExpiry = Math.ceil((end.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
      return daysUntilExpiry <= 7 && daysUntilExpiry > 0;
    };

    // Meta tags
    function upsertMeta(attr, name, content){
      let sel = `${attr}="${name}"`;
      let el = document.head.querySelector(`meta[${sel}]`);
      if (!el){ el = document.createElement('meta'); el.setAttribute(attr, name); document.head.appendChild(el); }
      el.setAttribute('content', content);
    }

    function injectOG(special){
      try{
        const title = `${special.title} ‚Äî TRODDR`;
        const desc = special.description || `Check out this special offer on TRODDR!`;
        let img = 'https://images.unsplash.com/photo-1540541338287-41700207dee6?w=1200&q=80';

        if (special.image_urls && Array.isArray(special.image_urls) && special.image_urls.length > 0) {
          img = special.image_urls[0];
        } else if (special.place?.image) {
          img = Array.isArray(special.place.image) ? special.place.image[0] : special.place.image;
        }

        const url = `${window.location.origin}/specials/${slug}`;

        document.title = title;
        upsertMeta('property','og:title', title);
        upsertMeta('property','og:description', desc);
        upsertMeta('property','og:type', 'website');
        upsertMeta('property','og:url', url);
        upsertMeta('property','og:image', img);
        upsertMeta('name','twitter:card','summary_large_image');
        upsertMeta('name','twitter:title', title);
        upsertMeta('name','twitter:description', desc);
        upsertMeta('name','twitter:image', img);
        upsertMeta('name', 'description', desc);

        let link = document.head.querySelector('link[rel="canonical"]');
        if (!link){
          link = document.createElement('link');
          link.setAttribute('rel','canonical');
          document.head.appendChild(link);
        }
        link.setAttribute('href', url);
      }catch(e){
        console.error('Error injecting OG tags', e);
      }
    }

    function renderDetails(special){
      const info = [];
      
      if (special.partner_name) {
        info.push(['Partner', special.partner_name, 'ü§ù']);
      }

      if (special.start_time || special.end_time) {
        const timeRange = formatTimeRange(special.start_time, special.end_time);
        if (timeRange) info.push(['Time', timeRange, '‚è∞']);
      }

      if (special.recurring_days && special.recurring_days.length > 0) {
        const startDate = new Date(special.start_date);
        const endDate = new Date(special.end_date);
        const isSingleDay = (
          startDate.getFullYear() === endDate.getFullYear() &&
          startDate.getMonth() === endDate.getMonth() &&
          startDate.getDate() === endDate.getDate()
        );
        
        if (!isSingleDay) {
          const days = special.recurring_days.map(day => 
            day.charAt(0).toUpperCase() + day.slice(1)
          ).join(', ');
          info.push(['Available Days', days, 'üîÑ']);
        }
      }

      if (info.length === 0) return;

      const el = $('#infoList');
      if (!el) return;

      el.innerHTML = info.map(([k, v, icon]) => `
        <div class="infoRow">
          <div class="icon">${icon}</div>
          <div class="kv">
            <div class="k">${k}</div>
            <div class="v">${v}</div>
          </div>
        </div>
      `).join('');
    }

    async function shareSpecial(special){
      const shareData = {
        title: special.title,
        text: special.description || `Check out this special offer${special.place ? ' at ' + special.place.name : ''}!`,
        url: window.location.href
      };

      try {
        if (navigator.share) {
          await navigator.share(shareData);
          track('special_shared', { method: 'web_share', special_slug: slug });
        } else {
          const text = `${shareData.title}\n${shareData.text}\n${shareData.url}`;
          await navigator.clipboard.writeText(text);
          alert('Link copied to clipboard!');
          track('special_shared', { method: 'copy_link', special_slug: slug });
        }
      } catch (err) {
        console.error('Error sharing:', err);
      }
    }

    async function main(){
      console.log('[Specials] Starting main()');

      if (!slug){
        set('special-title', 'Special not found');
        set('special-description', 'Please check the URL and try again.');
        console.error('[Specials] No slug found in URL');
        return;
      }

      track('special_page_viewed', { special_slug: slug });

      // Fetch special
      console.log('[Specials] Fetching special with slug:', slug);
      
      const { data: special, error } = await supa
        .from('specials')
        .select(`
          id,
          special_slug,
          title,
          description,
          image_urls,
          special_type,
          partner_name,
          start_date,
          end_date,
          start_time,
          end_time,
          recurring_days,
          discount_percentage,
          discount_amount,
          place:places!specials_place_id_fkey(
            id,
            name,
            slug,
            town,
            parish,
            image,
            category,
            address
          )
        `)
        .eq('special_slug', slug)
        .eq('active', true)
        .maybeSingle();

      console.log('[Specials] Query result:');
      console.log('  - Found:', !!special);
      console.log('  - Error:', error);
      console.log('  - Data:', special);

      if (error || !special) {
        console.error('[Specials] Error fetching special:', error);
        set('special-title', 'Special not found');
        set('special-description', 'This special offer may have expired or been removed.');
        return;
      }

      console.log('[Specials] Successfully loaded special:', special.title);

      // Special type badge
      const typeBadge = $('#special-type-badge');
      if (typeBadge) {
        const badgeColor = SPECIAL_TYPE_COLORS[special.special_type] || SPECIAL_TYPE_COLORS.general;
        const badgeLabel = SPECIAL_TYPE_LABELS[special.special_type] || SPECIAL_TYPE_LABELS.general;
        typeBadge.textContent = badgeLabel;
        typeBadge.className = `special-type-badge type-${special.special_type}`;
        typeBadge.style.display = 'inline-block';
        console.log('[Specials] Badge set:', badgeLabel);
      }

      // Title and description
      set('special-title', special.title);
      set('special-description', special.description || 'Enjoy this special offer!');
      console.log('[Specials] Title and description set');

      // Dates
      const datesEl = $('#special-dates');
      if (datesEl) {
        const dateText = formatDate(special.start_date) === formatDate(special.end_date)
          ? formatDate(special.start_date)
          : `${formatDate(special.start_date)} - ${formatDate(special.end_date)}`;
        datesEl.textContent = dateText;
        console.log('[Specials] Dates set:', dateText);
      }

      // Discount box
      if (special.discount_percentage || special.discount_amount) {
        const discountBox = $('#discount-box');
        const discountAmount = $('#discount-amount');
        if (discountBox) discountBox.style.display = 'block';
        if (discountAmount) {
          discountAmount.textContent = special.discount_percentage
            ? `${special.discount_percentage}% OFF`
            : `$${special.discount_amount} OFF`;
        }
        console.log('[Specials] Discount displayed');
      }

      // Details
      renderDetails(special);
      console.log('[Specials] Details rendered');

      // Expiring soon
      if (isExpiringSoon(special.end_date)) {
        const expiringBadge = $('#expiring-badge');
        if (expiringBadge) expiringBadge.style.display = 'inline-flex';
        console.log('[Specials] Expiring badge shown');
      }

      // Place section
      const place = special.place;
      if (place) {
        console.log('[Specials] Place data:', place);
        
        const placeSection = $('#place-section');
        if (placeSection) placeSection.style.display = 'block';
        
        const imageUrl = place.image
          ? (Array.isArray(place.image) ? place.image[0] : place.image)
          : null;
        
        const placeImage = $('#place-image');
        if (placeImage && imageUrl) {
          placeImage.src = imageUrl;
          placeImage.alt = place.name;
          console.log('[Specials] Place image set:', imageUrl);
        }
        
        set('place-name', place.name);
        set('place-address', [place.address, place.town, place.parish].filter(Boolean).join(', '));
        
        const categoryEmojis = { eat: 'üçΩÔ∏è', stay: 'üõèÔ∏è', play: 'üéØ' };
        const categoryText = place.category
          ? `${categoryEmojis[place.category] || ''} ${place.category.charAt(0).toUpperCase() + place.category.slice(1)}`
          : '';
        set('place-category', categoryText);

        // View place button
        if (place.slug) {
          const viewBtn = $('#view-place');
          if (viewBtn) {
            viewBtn.href = `/listings/${place.slug}`;
            viewBtn.style.display = 'inline-flex';
            viewBtn.addEventListener('click', () => {
              track('view_place_from_special', { 
                special_slug: slug,
                place_slug: place.slug 
              });
            });
          }
        }
        
        console.log('[Specials] Place section complete');
      }

      // Share button
      const shareBtn = $('#share-btn');
      if (shareBtn) {
        shareBtn.addEventListener('click', (e) => {
          e.preventDefault();
          shareSpecial(special);
        });
      }

      // Open in app
      const openAppLink = $('#open-in-app');
      if (openAppLink) {
        openAppLink.href = `troddr://special/${encodeURIComponent(slug)}`;
        openAppLink.addEventListener('click', (e) => {
          e.preventDefault();
          track('open_in_app', { special_slug: slug });
          window.location = openAppLink.href;
          setTimeout(() => {
            window.location = 'https://apps.apple.com/app/idYOUR_APP_ID';
          }, 1500);
        });
      }

      injectOG(special);
      console.log('[Specials] ‚úÖ Page render complete!');
    }

    main().catch(err => {
      console.error('[Specials] ‚ùå Fatal error:', err);
      set('special-title', 'Error loading special');
      set('special-description', 'Something went wrong. Please try again.');
    });
  </script>
</body>
</html>
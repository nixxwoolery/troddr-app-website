<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="TRODDR - Jamaica-first travel guide and trip planner. Discover where to eat, stay, and play like a local. Get authentic Caribbean travel experiences.">
    <meta name="keywords" content="Jamaica travel, Caribbean guide, local experiences, trip planner, authentic travel, Jamaica restaurants, local attractions">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="TRODDR - Experience Jamaica Like a Local">
    <meta property="og:description" content="Discover authentic Caribbean experiences with local recommendations for where to eat, stay, and play in Jamaica.">
    <meta property="og:image" content="https://troddr.com/images/og-image.jpg">
    <meta property="og:url" content="https://troddr.com">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="TRODDR - Experience Jamaica Like a Local">
    <meta name="twitter:description" content="Discover authentic Caribbean experiences with local recommendations for where to eat, stay, and play in Jamaica.">
    <meta name="twitter:image" content="https://troddr.com/images/twitter-image.jpg">
    
    <title>TRODDR - Experience Jamaica Like a Local | Authentic Caribbean Travel</title>

    <!-- Preload critical resources -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" as="style">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/images/troddr_logo.png">
    <link rel="icon" type="image/png" href="/images/troddr_logo.png">
    <link rel="apple-touch-icon" href="/images/troddr_logo.png">
    
    <!-- Stylesheets -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/itinerary.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
      /* Space the itinerary hero down from the global header */
      .trip-hero { margin-top: 36px; }

      /* Desktop header map */
      .hero-map{
        display:none;                /* hidden by default; only shown on large screens */
        height:320px;
        border-radius:8px;
        overflow:hidden;
        background:#eef2f7;
        border:1px solid #e5e7eb;
      }
      .hero-map .leaflet-container{
        height:100% !important;
        width:100% !important;
      }
      /* Allow message centering when no markers */
      #hero-map{ display:block; }
      .hero-map.empty{ display:flex; align-items:center; justify-content:center; color:#6b7280; }

      /* Reuse the rounded border for the preview map too */
      #hero-map .leaflet-container{ border-radius:12px; }

      /* Hide the bottom map section on desktop (we‚Äôre using the header map there) */
      @media (min-width: 1024px){
        #trip-map{ display:none; }
      }

      @media (min-width: 768px) {
        .trip-hero { margin-top: 56px; }
      }
      /* --- Trip meta polish --------------------------------------------------- */
      .trip-title { letter-spacing:.2px; }
      .trip-sub   { color:#6b7280; }

      .trip-meta{
        margin-top:14px;
        margin-bottom:6px;
        display:flex;
        flex-wrap:wrap;
        gap:12px;
        align-items:center;
      }
      .trip-meta .meta-pill{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding:8px 14px;
        border-radius:8px;
        background:#f8fafc;
        border:1px solid #e5e7eb;
        color:#0b1220;
        font-weight:600;
        line-height:1.2;
      }
      /* icons for pills */
      #meta-destination::before{ content:"üìç"; margin-right:6px; }
      #meta-dates::before{ content:"üóìÔ∏è"; margin-right:6px; }

      /* tighten buttons in the meta row */
      .trip-meta .btn{
        padding:10px 14px;
        border-radius:10px;
      }

      /* Sidebar detail icon alignment */
      #detail-destination::before{
        content:"üìç";
        margin-right:6px;
      }
      /* Modern hero layout */
      .trip-hero{
        display: grid;
        gap: 18px;
        align-items: start;
      }
      /* Responsive hero grid columns */
      @media (max-width:1023px){
        .trip-hero{ grid-template-columns:1fr; }
      }
      @media (min-width:1024px){
        .trip-hero{ grid-template-columns:1.15fr 0.85fr; align-items:stretch; }
        .hero-map{ display:block; }
      }
      @media (max-width: 900px){.trip-hero{gap:12px}}
      .trip-title{font-size:clamp(26px,3.6vw,44px);font-weight:800;margin:0}
      .trip-sub{color:#6b7280;margin:.35rem 0 0}

      /* Mobile header rows */
      .trip-loc{ margin-top:8px; }
      .trip-loc a{ color:#0b72c8; font-weight:700; text-decoration:none; border-bottom:none; box-shadow:none; }
      .days-root{ max-width:1100px; margin:0 auto; }
      .trip-loc a::before{ content:"üìç"; margin-right:6px; }

      .cat-pills{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
      .cat-pill{ padding:8px 14px; border-radius:8px; font-weight:700; color:#fff; }
      .pill-eat{  background:#007E94; }
      .pill-stay{ background:#c3D600; color:#0b1220; }
      .pill-play{ background:#77c7ac; }

      /* On mobile, prefer the simplified header; hide meta row */
      @media (max-width: 820px){
        .trip-meta{ display:none; }
      }

      /* Stats row */
      .stats{margin-top:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
      @media (max-width:640px){.stats{grid-template-columns:1fr 1fr}}
      .stat{background:#ffffff;border:1px solid #eef2f7;border-radius:12px;padding:12px 14px;display:flex;align-items:center;gap:10px;box-shadow:0 6px 16px rgba(15,23,42,.06)}
      .stat .num{font-weight:800;font-size:20px}
      .stat .lbl{color:#6b7280;font-weight:600;font-size:12px}

      /* Sticky bottom CTA on mobile */
      .sticky-cta{position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.98);backdrop-filter:saturate(120%) blur(6px);border-top:1px solid #e5e7eb;display:none;gap:10px;padding:10px 14px;z-index:999}
      .sticky-cta .cta-btn{flex:1;display:inline-flex;justify-content:center;align-items:center;padding:12px 14px;border-radius:12px;font-weight:700}
      .sticky-cta .primary{background:#0077cc;color:#fff}
      .sticky-cta .outline{background:#fff;border:1px solid #e5e7eb;color:#0077cc}
      .sticky-cta{ padding-bottom: calc(10px + var(--safe-bottom, env(safe-area-inset-bottom, 0px))); }
      @media (max-width: 820px){.sticky-cta{display:flex}}
      @media (max-width: 820px){
        #quick-actions{ display:none !important; }
      }

      /* Map container polish */
      #map-preview{
        position: relative;
        height: 100%;
        width: 100%;
        border-radius: 12px;
        overflow: hidden;
      }

      /* Trip map section at bottom */
      .mapCard{border-radius:0px;overflow:visible;background:#f8f9fa;border:1px solid #e5e7eb;margin:28px auto 40px;max-width:1100px}
      .mapHead{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:#fff;border-bottom:1px solid #e5e7eb}
      .mapBody{height:300px;background:#eef2f7;padding:12px}
      @media (max-width:820px){ .mapBody{height:260px} }
</style>
    <style>
      /* --- Mobile cover hero with overlay card --- */
      .hero-cover{ position:relative; height:350px; border-radius:0; overflow:hidden;
             background:#e5e7eb; background-size:cover; background-position:center; }

      @media (max-width: 640px){
        .hero-cover{
          display:block;
          margin:0;
          width:100%;
          margin-left:calc(50% - 50vw);
          margin-right:calc(50% - 50vw);
          border-radius:0;
        }
      }
      .hero-overlay{
        position:absolute; left:12px; right:12px; bottom:12px;
        background:rgba(255,255,255,.96); border-radius:8px;
        padding:12px 14px; box-shadow:0 10px 30px rgba(0,0,0,.15);
        backdrop-filter:saturate(120%) blur(4px);
      }
      .hero-overlay .trip-title{ font-size: clamp(18px, 5.5vw, 22px); margin:0; }
      .hero-overlay .trip-sub{ font-size:12px; margin:4px 0 6px; color:#6b7280; }
      .hero-overlay .trip-loc{ margin-top:0; }
      .hero-overlay .cat-pills{ margin-top:8px; }

      .hero-cover{
        position:relative; height:350px;overflow:hidden;
        background:#e5e7eb; background-size:cover; background-position:center;
      }

      /* Mobile: show cover, hide text block; white page background */
      @media (max-width: 640px){
        body{ background:#ffffff; }
        .hero-cover{
          display:block;
          margin:0;
          width:100vw;
          margin-left:calc(50% - 50vw);
          margin-right:calc(50% - 50vw);
          border-radius:0;
        }
        .hero-text{ display:none; }
        .trip-hero{ margin-top: 10px; padding-top: 0; }
      }

      /* Desktop: keep existing text hero, hide cover */
      @media (min-width: 641px){
        .hero-cover{ display:none; }
        .hero-text{ display:block; }
      }
    </style>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N0L5H68MFR"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-N0L5H68MFR');
    </script>

    <!-- Structured Data -->
    <!-- Map temporarily disabled
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    --> 
    <style>
            /* ---------------- Mobile header polish (app-like) ---------------- */
            @media (max-width: 640px){
        /* tighter, comfy spacing */
        .trip-hero{ margin-top: 48px; padding: 0; gap: 8px; }
        .days-root{ padding-left:16px; padding-right:16px; }

        /* title/sub sizing and clamping */
        .trip-title{ font-size: clamp(22px, 6vw, 28px); line-height: 1.15; }
        .trip-title{ display:-webkit-box; -webkit-box-orient:vertical; overflow:hidden; }
        .trip-sub{ font-size: 14px; margin-top: 4px; color:#6b7280; }

        /* location row */
        .trip-loc{ margin-top: 6px; }
        .trip-loc a{ font-size: 14px; font-weight: 700; }

            /* category pills */
            .cat-pills{ margin-top: 10px; gap: 8px; }
            .cat-pill{ border-radius: 8px; padding: 7px 12px; }

        /* stats grid sizing */
        .stats{ margin-top: 12px; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat{ padding: 10px 12px; border-radius: 10px; }
        .stat .num{ font-size: 18px; }
        .stat .lbl{ font-size: 11px; }

        /* hide the old meta row on small screens (already hidden at <=820px) */
        .trip-meta{ display:none !important; }
      }
    </style>
    <style>
      /* --- Day Stop Cards: sleeker look, tighter radius (8px) ------------------ */
      .day-section .stops{ 
        max-width: 760px;           /* narrower than full page */
        margin: 0 auto; 
        display: grid; 
        gap: 16px; 
      }

      .day-section .stop-card{
        border-radius: 8px;          /* requested radius */
        overflow: hidden;
        background: #fff;
        border: 1px solid #e6eaf0;  /* subtle edge */
        box-shadow: 0 1px 2px rgba(16,24,40,.06), 0 6px 20px rgba(16,24,40,.04);
      }

      .day-section .stop-cover{
        position: relative; 
        height: 250px;               /* tall, image-led card */
        background-size: cover;
        background-position: center;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
      }
      @media (max-width: 900px){
        .day-section .stop-cover{ height: 240px; }
      }

      .day-section .stop-body{ padding: 16px 18px 18px; }
      .day-section .stop-name{ font-size: clamp(18px,2.2vw,24px); font-weight: 600; margin: 0; }
      .day-section .stop-meta{ color:#6b7280; margin-top:6px; }

      .day-section .stop-actions{ display:flex; gap:10px; margin-top:12px; }
      .day-section .btn-mini{ 
        padding: 10px 12px; 
        border-radius: 8px;          /* match card radius language */
        border: 1px solid #e6eaf0; 
        background: #fff; 
        color:#0b1220; 
        font-weight: 600; 
      }
      .day-section .btn-mini:hover{ background:#f7f8fb; border-color:#cdd6e1; }
      .day-section{ padding-top:8px; }
</style>
    <!-- Bottom breathing room -->
    <style>
      :root{ --safe-bottom: env(safe-area-inset-bottom, 0px); }
      /* Give generous breathing room at the bottom so the last cards aren't flush with the screen
         and account for iOS/Android safe area + sticky CTA height on mobile. */
      body{ padding-bottom: calc(80px + var(--safe-bottom)); }
      @media (max-width:820px){
        body{ padding-bottom: calc(130px + var(--safe-bottom)); }
      }
      /* Add some extra space after the final day section as a safeguard */
      .day-section:last-of-type{ margin-bottom: 40px; }
      /* Also ensure the main mount has spacing */
      .days-root{ padding-bottom: 24px; }
    </style>
    <style id="mobile-bg-fix"></style>
    <style>
      /* Map temporarily disabled */
      .hero-map, #trip-map { display: none !important; }
    </style>
    <style>
      /* Force white background on small screens and neutralize any global dark theme */
      @media (max-width: 820px){
        html, body { background:#ffffff !important; }
        /* In case the global CSS draws background via pseudo elements */
        body::before, body::after { background: transparent !important; }
        /* Keep all main sections white as well */
        .page, .trip-hero, .hero-text, .mapCard, .footer, .section-container { background:#ffffff !important; }
        /* Prevent horizontal overflow that can expose the page background */
        .hero-cover{ width:100% !important; margin:0 !important; }
      }
    </style>
</head>
<body>
  <!-- Header -->

    <header class="header" role="banner">
      <div class="navbar">
          <a href="/index.html" class="logo" aria-label="TRODDR - Home">troddr</a>
          <!-- <button class="mobile-menu-btn" aria-label="Toggle navigation menu" aria-expanded="false">
              ‚ò∞
          </button> -->
          <button class="mobile-menu-btn"
                  aria-controls="primary-navigation"
                  aria-expanded="false"
                  aria-label="Open menu">
                  <span aria-hidden="true">‚ò∞</span>
          </button>
          <div class="nav-links" id="primary-navigation" role="navigation">
              <button class="nav-close-btn" aria-controls="primary-navigation" aria-label="Close menu">√ó</button>
              <a href="/about.html" class="nav-item">About</a>
              <a href="/index.html#features" class="nav-item">Features</a>
              <a href="/contact.html" class="nav-item">Contact</a>
              <a href="/index.html#waitlist" class="nav-cta">Join Waitlist</a>
          </div>
      </div>
  </header>

  <!-- Summary hero (dynamic) -->
  <section class="trip-hero">
    <!-- Mobile cover with overlay card -->
    <div class="hero-cover" id="hero-cover" aria-label="Trip cover">
      <div class="hero-overlay">
        <h1 class="trip-title" id="trip-title-ov">Loading‚Ä¶</h1>
        <div class="trip-loc"><a id="trip-loc-ov" href="#" target="_blank" rel="noopener">‚Äî</a></div>
        <p class="trip-sub" id="trip-sub-ov"></p>
        <div class="cat-pills" id="cat-pills-ov"></div>
      </div>
    </div>

    <!-- Desktop text hero -->
    <div class="hero-text">
      <h1 class="trip-title" id="trip-title">Loading‚Ä¶</h1>
      <p class="trip-sub" id="trip-sub"></p>
      <div class="trip-loc"><a id="trip-loc" href="#" target="_blank" rel="noopener">‚Äî</a></div>
      <div class="trip-meta" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:10px; align-items:center">
        <span class="meta-pill" id="meta-destination">‚Äî</span>
        <span class="meta-pill" id="meta-dates"></span>
        <div class="cat-pills" id="cat-pills"></div>
      </div>
      <button type="button" class="btn btn-primary" id="btn-save" aria-label="Open this itinerary in the TRODDR app">Open in App</button>
      <a class="btn btn-outline" href="#" id="btn-share" aria-label="Share this itinerary">Share</a>
      <div class="stats" id="stats-row"></div>
    </div>
    <!-- Map temporarily disabled
    <div class="hero-map" id="hero-map" role="img" aria-label="Trip map (overview)"></div>
    -->
  </section>

  <!-- Day tabs (dynamic) -->
  <nav class="day-tabs hidden" id="day-tabs" role="tablist" aria-label="Trip days">
    <div class="day-track" id="day-track"></div>
  </nav>

  <!-- Dynamic day sections mount here -->
  <main id="days-root" class="days-root" aria-live="polite"></main>

  <!-- Map temporarily disabled
  <section class="mapCard" id="trip-map">
    <div class="mapHead">
      <div style="font-weight:700">Trip Map</div>
    </div>
    <div class="mapBody">
      <div id="map-preview" aria-label="Trip map" role="img">Map preview</div>
    </div>
  </section>
  -->
   <!-- Footer -->
   <footer class="footer">
    <div class="section-container">
        <div class="footer-content">
            <div class="footer-section">
                <h3>TRODDR</h3>
                <p>Your ultimate Jamaican travel companion. Discover authentic experiences, plan perfect trips, and explore the island like a local.</p>
            </div>
            <div class="footer-section">
                <h3>Company</h3>
                <div class="footer-links">
                    <a href="about.html">About Us</a>
                    <a href="#features">Features</a>
                    <a href="contact.html">Contact</a>
                    <a href="#demo">Join Waitlist</a>
                </div>
            </div>
            <div class="footer-section">
                <h3>Discover</h3>
                <div class="footer-links">
                    <a href="#">Eat</a>
                    <a href="#">Stay</a>
                    <a href="#">Play</a>
                    <a href="#">Destinations</a>
                </div>
            </div>
            <div class="footer-section">
                <h3>Plan</h3>
                <div class="footer-links">
                    <a href="#">Trip Planner</a>
                    <a href="#">Itineraries</a>
                    <a href="#">Travel Guides</a>
                    <a href="#">Local Tips</a>
                </div>
            </div>
            <div class="footer-section">
                <h3>Support</h3>
                <div class="footer-links">
                    <a href="#">Help Center</a>
                    <a href="contact.html">Contact Us</a>
                    <a href="privacy.html">Privacy Policy</a>
                    <a href="terms.html">Terms of Service</a>
                </div>
            </div>
            <div class="footer-section">
                <h3>Contact</h3>
                <div class="footer-links">
                    <a href="mailto:hello@troddr.com">hello@troddr.com</a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>¬© 2025 TRODDR. Made with ‚ù§Ô∏è in Jamaica. Explore authentic experiences across the Caribbean.</p>
        </div>
    </div>
 </footer>

  <div class="sticky-cta" id="sticky-cta" role="region" aria-label="Quick actions">
    <a href="#" class="cta-btn outline" id="sticky-share">Share</a>
    <button type="button" class="cta-btn primary" id="sticky-open">Open in App</button>
  </div>

  <!-- Public env for static hosting: safe to expose anon key (RLS protects data) -->
  <script>
    window.env = {
      SUPABASE_URL: 'https://rprpwudhplodaqmmwqkf.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwcnB3dWRocGxvZGFxbW13cWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAyODcyODksImV4cCI6MjA2NTg2MzI4OX0.lNL6YZQqZgbsQRJyRAXpaWMC4LxncvPPyXNP1qopTFk'
    };
  </script>
  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>(function(){
    const menuBtn  = document.querySelector('.mobile-menu-btn');
    const navLinks = document.querySelector('.nav-links');
    const closeBtn = document.querySelector('.nav-close-btn');

    if (!menuBtn || !navLinks) return;

    // Toggle menu open/close
    menuBtn.addEventListener('click', function(){
      const isOpen = navLinks.classList.toggle('mobile-open');
      this.classList.toggle('active', isOpen);
      this.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      document.body.classList.toggle('menu-open', isOpen);
    });

    // Close when a nav link is clicked
    navLinks.addEventListener('click', function(e){
      const link = e.target.closest('a');
      if (!link) return;
      navLinks.classList.remove('mobile-open');
      menuBtn.classList.remove('active');
      menuBtn.setAttribute('aria-expanded', 'false');
      document.body.classList.remove('menu-open');
    });

    // ‚úÖ Close when the explicit close button is clicked
    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        navLinks.classList.remove('mobile-open');
        menuBtn.classList.remove('active');
        menuBtn.setAttribute('aria-expanded', 'false');
        document.body.classList.remove('menu-open');
      });
    }

    // Close on Escape key
    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape') {
        navLinks.classList.remove('mobile-open');
        menuBtn.classList.remove('active');
        menuBtn.setAttribute('aria-expanded', 'false');
        document.body.classList.remove('menu-open');
      }
    });
  })();
  (function(){
      const form = document.getElementById('waitlist-form');
      const success = document.getElementById('waitlist-success');
      if (!form) return;

      form.addEventListener('submit', function(e){
          e.preventDefault();

          const formData = new FormData(form);
          const params = new URLSearchParams(formData);

          // Build Mailchimp JSON endpoint from the normal action
          const base = form.action.replace('/post?', '/post-json?');
          const url = base + '&' + params.toString() + '&c=?';

          // Fire request; assume success for UX and still let Mailchimp process
          fetch(url, { method: 'GET', mode: 'no-cors' })
          .then(function(){
              form.style.display = 'none';
              if (success) success.style.display = 'block';
              try { gtag('event', 'waitlist_signup', { method: 'mailchimp' }); } catch(err){}
          })
          .catch(function(){
              // Fallback: submit normally if fetch fails
              form.submit();
          });
      });
  })();</script>
  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = window.env?.SUPABASE_URL || 'https://YOUR_SUPABASE_PROJECT.supabase.co';
    const SUPABASE_ANON_KEY = window.env?.SUPABASE_ANON_KEY || 'YOUR_PUBLIC_ANON_KEY';
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } });

    // ====== DOM HOOKS ======
    const $ = (sel) => document.querySelector(sel);
    const dayTabs = $('#day-tabs');
    const dayTrack = $('#day-track');
    const daysRoot = $('#days-root');
    const titleEl = $('#trip-title');
    const subEl = $('#trip-sub');
    const destMeta = $('#meta-destination');
    const datesMeta = $('#meta-dates');
    const destDetail = $('#detail-destination');
    const copyBtn = $('#btn-copy');
    const saveBtn = $('#btn-save');
    const errorBox = $('#error-box');
    const errorDetail = $('#error-detail');
    const debug = (...args) => { try { console.debug('[itinerary]', ...args); } catch {} };
    debug('ENV', { url: SUPABASE_URL && 'ok', anon: SUPABASE_ANON_KEY ? 'set' : 'missing' });

    // ====== URL FLAG HELPER ======
    const urlFlag = (k) => new URLSearchParams(location.search.replace(/^\?/, '')).get(k) || new URLSearchParams(location.hash.replace(/^#/, '')).get(k);

    // ====== UTIL ======
    const fmtDate = (iso) => {
      if (!iso) return '';
      try { return new Date(iso).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' }); } catch { return iso; }
    };
    const fmtRange = (s, e) => {
      if (s && e){
        const ds = new Date(s), de = new Date(e);
        if (ds.toDateString() === de.toDateString()) return fmtDate(s); // single day
        return `${fmtDate(s)} ‚Äì ${fmtDate(e)}`;
      }
      return (s || e) ? fmtDate(s || e) : '';
    };

    // Display times in 12‚Äëhour format like "1:30 PM"
    const to12h = (t) => {
      if (!t) return '';
      const m = String(t).match(/^(\d{1,2}):(\d{2})(?::\d{2})?$/);
      if (!m) return String(t);
      let h = parseInt(m[1], 10);
      const mm = m[2];
      const suffix = h >= 12 ? 'PM' : 'AM';
      h = h % 12; if (h === 0) h = 12;
      return `${h}:${mm} ${suffix}`;
    };

    const parseIdentifierFromUrl = () => {
      const { pathname, search, hash } = location;

      // 1) /itinerary/<id-or-token>
      const parts = (pathname || '').split('/').filter(Boolean);
      const i = parts.findIndex(p => p.toLowerCase() === 'itinerary');
      if (i >= 0 && parts[i + 1]) return parts[i + 1];

      // 2) /itinerary.html/<id-or-token>
      const ih = parts.findIndex(p => p.toLowerCase().includes('itinerary.html'));
      if (ih >= 0 && parts[ih + 1]) return parts[ih + 1];

      // 3) ?id=... or ?token=...
      const qs = new URLSearchParams(search || '');
      const qId = qs.get('id');
      if (qId) return qId;
      const qTok = qs.get('token');
      if (qTok) return qTok;

      // 4) #id=... or #token=...
      if (hash) {
        const hs = new URLSearchParams(hash.replace(/^#/, ''));
        const hId = hs.get('id');
        if (hId) return hId;
        const hTok = hs.get('token');
        if (hTok) return hTok;
      }

      return null;
    };

    const groupByDay = (items=[]) => {
      const buckets = new Map();
      items.forEach(it => {
        const k = it.planned_day || 'undated';
        if (!buckets.has(k)) buckets.set(k, []);
        buckets.get(k).push(it);
      });
      // sort dated keys asc, undated last
      const keys = Array.from(buckets.keys()).sort((a,b) => {
        if (a==='undated') return 1; if (b==='undated') return -1;
        return new Date(a) - new Date(b);
      });
      return { keys, buckets };
    };

    // Helper to detect UUIDs
    const isUuid = (s) => /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s);

    function mountMapPreview(items, targetId = 'map-preview'){
      const el = document.getElementById(targetId);
      if (!el || !window.L) return;

      // Ensure container has explicit dimensions
      el.style.height = '100%';
      el.style.width  = '100%';

      // Extract coords from the given list
      const coords = (items || []).map(it => {
        const lat = Number(it.latitude ?? it.lat ?? it.Latitude ?? it.Lat);
        const lng = Number(it.longitude ?? it.lng ?? it.Longitude ?? it.Lng ?? it.lon);
        if (Number.isFinite(lat) && Number.isFinite(lng)) return [lat, lng, it];
        return null;
      }).filter(Boolean);

      // Reset container each time (simple + robust)
      el.innerHTML = '';
      if (!coords.length){
        el.classList.add('empty');
        el.style.display = 'flex';
        el.style.alignItems = 'center';
        el.style.justifyContent = 'center';
        el.textContent = 'Map preview unavailable';
        return;
      }
      el.classList.remove('empty');

      const map = L.map(el, { zoomControl: false });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // Invalidate size after mount to ensure correct rendering
      setTimeout(() => { try { map.invalidateSize(); } catch {} }, 0);

      const boundsPts = [];
      const routePts = [];
      coords.forEach(([lat, lng, it]) => {
        const pt = L.latLng(lat, lng);
        boundsPts.push(pt);
        routePts.push(pt);
        const marker = L.circleMarker(pt, { radius: 6, weight: 2, color: '#0077cc', fillColor: '#0077cc', fillOpacity: 0.2 });
        marker.addTo(map);
        if (it && (it.name || it.town)){
          const lines = [it.name, [it.town, it.parish].filter(Boolean).join(', ')].filter(Boolean);
          marker.bindPopup(lines.join('<br/>'));
        }
      });

      if (routePts.length > 1){
        L.polyline(routePts, { color: '#0077cc', weight: 3, opacity: 0.75, lineJoin: 'round' }).addTo(map);
      }

      const bounds = L.latLngBounds(boundsPts);
      map.fitBounds(bounds, { padding: [24, 24] });
    }

    function haversineKm(a, b){
      const toRad = d => d * Math.PI / 180;
      const R = 6371;
      const dLat = toRad(b.lat - a.lat);
      const dLng = toRad(b.lng - a.lng);
      const s = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
      return 2 * R * Math.asin(Math.sqrt(s));
    }
    function computeDistanceKm(items){
      const pts = (items||[]).map(it => ({ lat:Number(it.latitude ?? it.lat), lng:Number(it.longitude ?? it.lng ?? it.lon) })).filter(p => Number.isFinite(p.lat) && Number.isFinite(p.lng));
      if (pts.length < 2) return 0;
      let sum = 0; for (let i=1;i<pts.length;i++){ sum += haversineKm(pts[i-1], pts[i]); }
      return Math.round(sum);
    }

    // Resolve listing slugs for items that don't include .slug
    async function primeSlugMap(items){
      try{
        const ids = Array.from(new Set((items||[])
          .filter(x => !x.slug && (x.place_id || x.id))
          .map(x => x.place_id || x.id)
          .filter(Boolean)));
        if (!ids.length) return {};
        const { data, error } = await supa
          .from('places') 
          .select('id, slug')
          .in('id', ids);
        if (error || !data) return {};
        const map = {};
        data.forEach(r => { if (r && r.id && r.slug) map[r.id] = r.slug; });
        return map;
      }catch(e){ return {}; }
    }

    // Pull in coordinates for items that are missing lat/lng (fallback join on places)
    async function hydrateCoords(items){
      try{
        const needs = (items || []).filter(it => {
          const lat = Number(it.latitude ?? it.lat ?? it.Latitude ?? it.Lat);
          const lng = Number(it.longitude ?? it.lng ?? it.Longitude ?? it.Lng ?? it.lon);
          return !(Number.isFinite(lat) && Number.isFinite(lng));
        });
        const ids = Array.from(new Set(needs.map(it => it.place_id || it.id).filter(Boolean)));
        if (!ids.length) return items;

        const { data, error } = await supa
          .from('places')
          .select('id, latitude, longitude, lat, lng, town, parish')
          .in('id', ids);
        if (error || !data) return items;

        const byId = Object.fromEntries(data.map(r => [r.id, r]));
        items.forEach(it => {
          const key = it.place_id || it.id;
          const m = byId[key];
          if (!m) return;
          const lat = Number(it.latitude ?? it.lat ?? m.latitude ?? m.lat);
          const lng = Number(it.longitude ?? it.lng ?? m.longitude ?? m.lng);
          if (Number.isFinite(lat)) it.latitude = lat;
          if (Number.isFinite(lng)) it.longitude = lng;
          if (!it.town && m.town) it.town = m.town;
          if (!it.parish && m.parish) it.parish = m.parish;
        });
      }catch(e){ /* ignore */ }
      return items;
    }
    function listingHrefFor(item, slugMap){
      const s = item?.slug || item?.place_slug || slugMap[item?.place_id || item?.id];
      return s ? `/listings.html?slug=${encodeURIComponent(s)}` : '';
    }

    function setupItineraryShare(ident, meta){
      const url = location.href.split('#')[0];
      const range = (meta.start_date && meta.end_date) ? `${new Date(meta.start_date).toDateString()} to ${new Date(meta.end_date).toDateString()}` : '';
      const text = `I'm going to ${meta.destination || 'Jamaica'} ${range ? 'from ' + range + ' ' : ''}with ${ (meta.items_count ?? '') } stops! Check out my trip plans!`;
      const shareData = { title: meta.title || 'TRODDR Itinerary', text, url };
      const btn = document.getElementById('btn-share');
      const stickyShare = document.getElementById('sticky-share');
      const stickyOpen = document.getElementById('sticky-open');

      async function doShare(e){
        e.preventDefault();
        try {
          if (navigator.share){ await navigator.share(shareData); return; }
          await navigator.clipboard.writeText(url); alert('Link copied!');
        } catch {}
      }
      if (btn) btn.addEventListener('click', doShare);
      if (stickyShare) stickyShare.addEventListener('click', doShare);
      if (stickyOpen){
        stickyOpen.addEventListener('click', (e)=>{
          e.preventDefault();
          const deep = `troddrapp://shared_itinerary/${encodeURIComponent(String(ident))}`;
          window.location.href = deep;
        });
      }
    }

    function renderCategoryPills(meta, items, elId='cat-pills'){
      const el = document.getElementById(elId); 
      if (!el) return '';
      const counts = { eat:0, stay:0, play:0 };
      (items || []).forEach(it => {
        const c = String(it.category || '').toLowerCase();
        if (c.includes('eat')) counts.eat++;
        else if (c.includes('stay')) counts.stay++;
        else if (c.includes('play')) counts.play++;
      });
      const pills = [];
      if (counts.eat)  pills.push(`<span class="cat-pill pill-eat">${counts.eat} Eat</span>`);
      if (counts.stay) pills.push(`<span class="cat-pill pill-stay">${counts.stay} Stay</span>`);
      if (counts.play) pills.push(`<span class="cat-pill pill-play">${counts.play} Play</span>`);
      el.innerHTML = pills.join('');
      return el.innerHTML;
    }

    async function render(items, meta){
      // Header/meta
      const slugMap = await primeSlugMap(items);
      titleEl.textContent = meta.title || 'Itinerary';
      // Set mobile overlay title too
      const titleOv = document.getElementById('trip-title-ov');
      if (titleOv) titleOv.textContent = meta.title || 'Itinerary';

      // Subtitle = date range
      const range = fmtRange(meta.start_date, meta.end_date);
      subEl.textContent = range || '';
      // Overlay duplicates for mobile
      const subOv = document.getElementById('trip-sub-ov');
      if (subOv) subOv.textContent = range || '';

      // Location link (also keep meta/side detail up to date)
      const locA = document.getElementById('trip-loc');
      const q = meta.destination || '';
      if (locA){
        locA.textContent = q || '‚Äî';
        locA.href = q ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}` : '#';
      }
      // Overlay duplicates for mobile
      const locAov = document.getElementById('trip-loc-ov');
      if (locAov){
        locAov.textContent = q || '‚Äî';
        locAov.href = q ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}` : '#';
      }
      destMeta.textContent = meta.destination || '‚Äî';
      if (destDetail) destDetail.textContent = meta.destination || '‚Äî';

      datesMeta.textContent = range ? `${range}` : '';

      // Category pills (Eat/Stay/Play)
      renderCategoryPills(meta, items, 'cat-pills');
      renderCategoryPills(meta, items, 'cat-pills-ov');

      // Choose a cover image (first item image fallback)
      const coverEl = document.getElementById('hero-cover');
      if (coverEl){
        const firstWithImage = (items || []).find(x => x && x.image);
        const coverUrl = firstWithImage?.image || 'https://images.unsplash.com/photo-1502920917128-1aa500764b8a?q=80&w=1600&auto=format&fit=crop';
        coverEl.style.backgroundImage = `url('${coverUrl}')`;
      }

      // Show who shared it (if provided by RPC)
      const createdByEl = document.getElementById('detail-createdby');
      if (createdByEl) {
        createdByEl.textContent = meta.owner_name
          ? `üë§ ${meta.owner_name} shared this itinerary`
          : 'üë§ Shared itinerary';
      }

      // Tabs + sections
      const { keys, buckets } = groupByDay(items);
      // Map temporarily disabled
      const pickMapTarget = () => null;
      let mapTarget = pickMapTarget();
      dayTrack.innerHTML = '';
      daysRoot.innerHTML = '';

      if (keys.length) dayTabs.classList.remove('hidden');
      const daysData = [];
      keys.forEach((k, i) => {
        const label = k === 'undated' ? 'Any day' : fmtDate(k);
        // tab
        const a = document.createElement('a');
        a.className = 'day-pill' + (i===0 ? ' active' : '');
        a.href = `#day-${i+1}`;
        a.textContent = label;
        dayTrack.appendChild(a);

        // section
        const sec = document.createElement('section');
        sec.id = `day-${i+1}`;
        sec.className = 'day-section';
        sec.innerHTML = `
          <div class="day-header">
            <h2 class="day-title">${label}</h2>
            <span class="day-date"></span>
          </div>
          <div class="stops"></div>
        `;
        const stopWrap = sec.querySelector('.stops');

        const itemsForDay = buckets.get(k).slice().sort((a,b)=>{
          const ta = a.planned_time || '99:99';
          const tb = b.planned_time || '99:99';
          return ta.localeCompare(tb);
        });
        daysData.push(itemsForDay);

        itemsForDay.forEach(item => {
          const cat = (item.category||'').toLowerCase();
          const badge = cat ? `<span class="badge ${cat}">${cat.toUpperCase()}</span>` : '';
          const cover = item.image ? `style="background-image:url('${item.image}')"` : '';
          const place = document.createElement('article');
          place.className = 'stop-card';
          const viewHref = listingHrefFor(item, slugMap);
          place.innerHTML = `
            <div class="stop-cover" ${cover}>
              ${item.planned_time ? `<span class="time-badge">${to12h(item.planned_time)}</span>` : ''}
            </div>
            <div class="stop-body">
              <div class="stop-top">
                <h3 class="stop-name">${item.name || 'Place'}</h3>
                ${badge}
              </div>
              <div class="stop-meta"><span>${item.town || item.parish || item.location || ''}</span></div>
              <div class="stop-actions">
                ${viewHref ? `<a class="btn-mini" href="${viewHref}">View</a>` : ''}
                <a class="btn-mini" target="_blank" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.name + ' ' + (item.town||''))}">Directions</a>
              </div>
            </div>`;
          stopWrap.appendChild(place);
        });

        daysRoot.appendChild(sec);
      });

      // Click to scroll + update map for that day
      const tabs = Array.from(document.querySelectorAll('.day-pill'));
      tabs.forEach((t, i) => {
        t.addEventListener('click', (e)=>{
          e.preventDefault();
          const sec = document.querySelector(`#day-${i+1}`);
          if (sec) sec.scrollIntoView({ behavior: 'smooth', block: 'start' });
          if (daysData[i] && mapTarget) mountMapPreview(daysData[i], mapTarget);
        });
      });

      // Initial map draws for first dated day (or all items)
      const firstNonEmpty = daysData.find(d => d && d.length) || items;
      if (mapTarget) mountMapPreview(firstNonEmpty, mapTarget);

      const tabs2 = Array.from(document.querySelectorAll('.day-pill'));
      const sections = tabs2.map(t => document.querySelector(t.getAttribute('href'))).filter(Boolean);
      let lastActive = -1;
      const onScroll = () => {
        const y = window.scrollY + 140;
        let activeIndex = 0;
        sections.forEach((sec,i)=>{ if(sec.offsetTop <= y) activeIndex = i; });
        if (activeIndex !== lastActive){
          tabs2.forEach((t,i)=> t.classList.toggle('active', i===activeIndex));
          if (daysData[activeIndex]) {
            mapTarget = pickMapTarget();
            if (mapTarget) mountMapPreview(daysData[activeIndex], mapTarget);
          }
          lastActive = activeIndex;
        }
      };
      document.addEventListener('scroll', onScroll, {passive:true});
      onScroll();
    }

    // ====== DEBUG PANEL ======
    function mountDebugPanel(ctx){
      if (!(urlFlag('debug') === '1')) return; // opt-in only
      const box = document.createElement('pre');
      box.id = 'itinerary-debug';
      box.style.cssText = 'position:fixed;bottom:10px;right:10px;z-index:9999;max-width:90vw;max-height:40vh;overflow:auto;background:#0b1220;color:#e5e7eb;border:1px solid #1f2937;border-radius:8px;padding:10px;font-size:12px;box-shadow:0 8px 24px rgba(0,0,0,.4)';
      box.textContent = JSON.stringify(ctx, null, 2);
      document.body.appendChild(box);
      return (extra) => { try { box.textContent = JSON.stringify({ ...ctx, ...extra }, null, 2); } catch {} };
    }

    async function main(){
      const dbg = mountDebugPanel({ phase: 'start', href: location.href });
      const ident = parseIdentifierFromUrl();
      const looksUuid = isUuid(String(ident));
      debug('parsed identifier', { ident, looksUuid });
      if (dbg) dbg({ phase: 'ident', ident, looksUuid });
      if (saveBtn && ident) {
        // Store deep link for use in the click handler
        saveBtn.dataset.deep = `troddrapp://shared_itinerary/${encodeURIComponent(ident)}`;
      }
      if (!ident){
        errorBox.classList.remove('hidden');
        titleEl.textContent = 'Invalid link';
        if (errorDetail) errorDetail.textContent = 'No identifier found. Use /itinerary/<itinerary-id> or /itinerary/<token>.';
        return;
      }
      try{
        let data, error;

        // Always try TOKEN flow first (works for both dashed and dashless tokens)
        let res = await supa.rpc('get_shared_itinerary', { _token: ident });
        data = res.data; error = res.error;
        debug('RPC get_shared_itinerary (as-is)', { hasData: !!data, hasError: !!error });
        if (dbg) dbg({ phase: 'rpc1_token', hasData: !!data, hasError: !!error });

        // Retry with dashless if original had dashes
        if ((!data || error) && String(ident).includes('-')) {
          const tokenNoDash = String(ident).replace(/-/g, '');
          debug('Retry token dashless', tokenNoDash);
          res = await supa.rpc('get_shared_itinerary', { _token: tokenNoDash });
          data = res.data; error = res.error;
          if (dbg) dbg({ phase: 'rpc2_dashless', hasData: !!data, hasError: !!error });
        }

        // Retry with dashed UUID shape if it looks like 32-hex (dashless)
        if ((!data || error) && /^[0-9a-fA-F]{32}$/.test(String(ident))) {
          const tokenDashed = String(ident).replace(/^(.{8})(.{4})(.{4})(.{4})(.{12})$/, '$1-$2-$3-$4-$5');
          debug('Retry token dashed', tokenDashed);
          res = await supa.rpc('get_shared_itinerary', { _token: tokenDashed });
          data = res.data; error = res.error;
          if (dbg) dbg({ phase: 'rpc3_dashed', hasData: !!data, hasError: !!error });
        }

        // If still not found and it LOOKS like a UUID, try by-itinerary-id
        if ((!data || error) && looksUuid) {
          const byId = await supa.rpc('get_shared_itinerary_by_id', { _itinerary_id: ident });
          data = byId.data; error = byId.error;
          debug('RPC get_shared_itinerary_by_id', { hasData: !!data, hasError: !!error, ident });
          if (dbg) dbg({ phase: 'byId', hasData: !!data, hasError: !!error });
        }

        if (error || !data){ throw error || new Error('Not found'); }
        if (dbg) dbg({ phase: 'render', items: Array.isArray(data.items) ? data.items.length : 0, metaTitle: data.title });
        const itemsHydrated = await hydrateCoords(data.items || []);
        await render(itemsHydrated, data);
        setupItineraryShare(ident, data);

        // Clear any prior error UI or title from earlier attempts
        if (errorBox) errorBox.classList.add('hidden');
        if (titleEl) titleEl.textContent = data.title || 'Itinerary';

        // Bump views (ignore errors) ‚Äî run via async IIFE so it doesn't throw synchronously
        (async () => {
          try { await supa.rpc('bump_share_view', { _token: String(ident) }); } catch (e) {}
        })();

        // Wire buttons
        if (copyBtn){
          copyBtn.addEventListener('click', async () => {
            try{ await navigator.clipboard.writeText(location.href); copyBtn.textContent='Copied!'; setTimeout(()=>copyBtn.textContent='Copy Link', 1600);}catch(e){ alert('Copy failed'); }
          });
        }
        if (saveBtn){
          saveBtn.addEventListener('click', () => {
            const deep = saveBtn.dataset.deep || `troddrapp://shared_itinerary/${encodeURIComponent(String(ident))}`;
            window.location.href = deep;
          });
        }
      }catch(e){
        if (typeof dbg === 'function') dbg({ phase: 'error', message: (e && e.message) || String(e) });
        console.error('[itinerary] load error', e);
        errorBox.classList.remove('hidden');
        titleEl.textContent = 'Itinerary unavailable';
        if (errorDetail) errorDetail.textContent = (e && e.message) ? e.message : 'Failed to fetch from Supabase. Check env vars and RPC permissions.';
      }
    }

    main();
  </script>
</body>
</html>
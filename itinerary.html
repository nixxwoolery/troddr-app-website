

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="TRODDR - Jamaica-first travel guide and trip planner. Discover where to eat, stay, and play like a local. Get authentic Caribbean travel experiences.">
    <meta name="keywords" content="Jamaica travel, Caribbean guide, local experiences, trip planner, authentic travel, Jamaica restaurants, local attractions">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="TRODDR - Experience Jamaica Like a Local">
    <meta property="og:description" content="Discover authentic Caribbean experiences with local recommendations for where to eat, stay, and play in Jamaica.">
    <meta property="og:image" content="https://troddr.com/images/og-image.jpg">
    <meta property="og:url" content="https://troddr.com">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="TRODDR - Experience Jamaica Like a Local">
    <meta name="twitter:description" content="Discover authentic Caribbean experiences with local recommendations for where to eat, stay, and play in Jamaica.">
    <meta name="twitter:image" content="https://troddr.com/images/twitter-image.jpg">
    
    <title>TRODDR - Experience Jamaica Like a Local | Authentic Caribbean Travel</title>

    <!-- Preload critical resources -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" as="style">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/images/troddr_logo.png">
    <link rel="icon" type="image/png" href="/images/troddr_logo.png">
    <link rel="apple-touch-icon" href="/images/troddr_logo.png">
    
    <!-- Stylesheets -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/itinerary.css">
    <link rel="stylesheet" href="/css/style.css">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N0L5H68MFR"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-N0L5H68MFR');
    </script>

    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "TRODDR",
        "description": "Jamaica-first travel guide and trip planner for authentic Caribbean experiences",
        "url": "https://troddr.com",
        "applicationCategory": "TravelApplication",
        "operatingSystem": "iOS, Android, Web",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "publisher": {
            "@type": "Organization",
            "name": "TRODDR Ltd",
            "url": "https://troddr.com"
        }
    }
    </script>
</head>
<body>
  <!-- Header -->

    <header class="header" role="banner">
      <div class="navbar">
          <a href="/index.html" class="logo" aria-label="TRODDR - Home">troddr</a>
          <!-- <button class="mobile-menu-btn" aria-label="Toggle navigation menu" aria-expanded="false">
              ‚ò∞
          </button> -->
          <button class="mobile-menu-btn"
                  aria-controls="primary-navigation"
                  aria-expanded="false"
                  aria-label="Open menu">
                  <span aria-hidden="true">‚ò∞</span>
          </button>
          <div class="nav-links" id="primary-navigation" role="navigation">
              <button class="nav-close-btn" aria-controls="primary-navigation" aria-label="Close menu">√ó</button>
              <a href="/about.html" class="nav-item">About</a>
              <a href="/index.html#features" class="nav-item">Features</a>
              <a href="/contact.html" class="nav-item">Contact</a>
              <a href="/index.html#waitlist" class="nav-cta">Join Waitlist</a>
          </div>
      </div>
  </header>

  <!-- Summary hero (dynamic) -->
  <section class="trip-hero">
    <div>
      <h1 class="trip-title" id="trip-title">Loading‚Ä¶</h1>
      <p class="trip-sub" id="trip-sub"></p>
      <div class="trip-meta" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:10px; align-items:center">
        <span class="meta-pill" id="meta-destination">‚Äî</span>
        <span class="meta-pill" id="meta-dates"></span>
        <button class="btn" id="btn-copy">Copy Link</button>
        <a class="btn btn-primary" href="troddrapp://import/shared_itinerary?token=<TOKEN>" id="btn-save">Open in App</a>
      </div>
    </div>
    <div class="map-wrap" id="map-preview">Map preview</div>
  </section>

  <!-- Day tabs (dynamic) -->
  <nav class="day-tabs hidden" id="day-tabs">
    <div class="day-track" id="day-track"></div>
  </nav>

  <!-- Page layout: sidebar + content (dynamic) -->
  <main class="page">
    <aside class="sidebar">
      <div class="stop-card" style="padding:14px">
        <h3 style="margin:6px 0 4px">Trip Details</h3>
        <div class="stop-meta"><span id="detail-createdby">üë§ Shared itinerary</span></div>
        <div class="stop-meta"><span id="detail-base">üìç Destination: <span id="detail-destination">‚Äî</span></span></div>
      </div>
      <div style="height:14px"></div>
      <div class="stop-card" style="padding:14px">
        <h3 style="margin:6px 0 10px">Quick Actions</h3>
        <div class="stop-actions">
          <a class="btn-mini" href="#" id="qa-open-maps">Open in Maps</a>
        </div>
      </div>
      <div id="error-box" class="error hidden">
        <div style="font-weight:700;margin-bottom:6px">Unable to load itinerary.</div>
        <div id="error-detail">The link may be invalid or expired.</div>
      </div>
    </aside>

    <section id="days-root"></section>
  </main>

  <!-- Public env for static hosting: safe to expose anon key (RLS protects data) -->
  <script>
    window.env = {
      SUPABASE_URL: 'https://rprpwudhplodaqmmwqkf.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwcnB3dWRocGxvZGFxbW13cWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAyODcyODksImV4cCI6MjA2NTg2MzI4OX0.lNL6YZQqZgbsQRJyRAXpaWMC4LxncvPPyXNP1qopTFk'
    };
  </script>
  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>(function(){
    const menuBtn  = document.querySelector('.mobile-menu-btn');
    const navLinks = document.querySelector('.nav-links');
    const closeBtn = document.querySelector('.nav-close-btn');

    if (!menuBtn || !navLinks) return;

    // Toggle menu open/close
    menuBtn.addEventListener('click', function(){
      const isOpen = navLinks.classList.toggle('mobile-open');
      this.classList.toggle('active', isOpen);
      this.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      document.body.classList.toggle('menu-open', isOpen);
    });

    // Close when a nav link is clicked
    navLinks.addEventListener('click', function(e){
      const link = e.target.closest('a');
      if (!link) return;
      navLinks.classList.remove('mobile-open');
      menuBtn.classList.remove('active');
      menuBtn.setAttribute('aria-expanded', 'false');
      document.body.classList.remove('menu-open');
    });

    // ‚úÖ Close when the explicit close button is clicked
    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        navLinks.classList.remove('mobile-open');
        menuBtn.classList.remove('active');
        menuBtn.setAttribute('aria-expanded', 'false');
        document.body.classList.remove('menu-open');
      });
    }

    // Close on Escape key
    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape') {
        navLinks.classList.remove('mobile-open');
        menuBtn.classList.remove('active');
        menuBtn.setAttribute('aria-expanded', 'false');
        document.body.classList.remove('menu-open');
      }
    });
  })();
  (function(){
      const form = document.getElementById('waitlist-form');
      const success = document.getElementById('waitlist-success');
      if (!form) return;

      form.addEventListener('submit', function(e){
          e.preventDefault();

          const formData = new FormData(form);
          const params = new URLSearchParams(formData);

          // Build Mailchimp JSON endpoint from the normal action
          const base = form.action.replace('/post?', '/post-json?');
          const url = base + '&' + params.toString() + '&c=?';

          // Fire request; assume success for UX and still let Mailchimp process
          fetch(url, { method: 'GET', mode: 'no-cors' })
          .then(function(){
              form.style.display = 'none';
              if (success) success.style.display = 'block';
              try { gtag('event', 'waitlist_signup', { method: 'mailchimp' }); } catch(err){}
          })
          .catch(function(){
              // Fallback: submit normally if fetch fails
              form.submit();
          });
      });
  })();</script>
  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = window.env?.SUPABASE_URL || 'https://YOUR_SUPABASE_PROJECT.supabase.co';
    const SUPABASE_ANON_KEY = window.env?.SUPABASE_ANON_KEY || 'YOUR_PUBLIC_ANON_KEY';
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } });

    // ====== DOM HOOKS ======
    const $ = (sel) => document.querySelector(sel);
    const dayTabs = $('#day-tabs');
    const dayTrack = $('#day-track');
    const daysRoot = $('#days-root');
    const titleEl = $('#trip-title');
    const subEl = $('#trip-sub');
    const destMeta = $('#meta-destination');
    const datesMeta = $('#meta-dates');
    const destDetail = $('#detail-destination');
    const copyBtn = $('#btn-copy');
    const saveBtn = $('#btn-save');
    const errorBox = $('#error-box');
    const errorDetail = $('#error-detail');
    const debug = (...args) => { try { console.debug('[itinerary]', ...args); } catch {} };
    debug('ENV', { url: SUPABASE_URL && 'ok', anon: SUPABASE_ANON_KEY ? 'set' : 'missing' });

    // ====== UTIL ======
    const fmtDate = (iso) => {
      if (!iso) return '';
      try { return new Date(iso).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' }); } catch { return iso; }
    };
    const fmtRange = (s, e) => s && e ? `${fmtDate(s)} ‚Äì ${fmtDate(e)}` : (s || e ? (fmtDate(s||e)) : '');

    const parseTokenFromPath = () => {
      // Expect /itinerary/<token>
      const parts = (location.pathname || '').split('/').filter(Boolean);
      const idx = parts.findIndex(p => p.toLowerCase() === 'itinerary');
      return idx >= 0 ? parts[idx+1] : null;
    };

    const groupByDay = (items=[]) => {
      const buckets = new Map();
      items.forEach(it => {
        const k = it.planned_day || 'undated';
        if (!buckets.has(k)) buckets.set(k, []);
        buckets.get(k).push(it);
      });
      // sort dated keys asc, undated last
      const keys = Array.from(buckets.keys()).sort((a,b) => {
        if (a==='undated') return 1; if (b==='undated') return -1;
        return new Date(a) - new Date(b);
      });
      return { keys, buckets };
    };

    // Helper to detect UUIDs
    const isUuid = (s) => /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s);

    function render(items, meta){
      // Header/meta
      titleEl.textContent = meta.title || 'Itinerary';
      subEl.textContent = meta.destination ? `Around ${meta.destination}` : '';
      destMeta.textContent = meta.destination || '‚Äî';
      const range = fmtRange(meta.start_date, meta.end_date);
      datesMeta.textContent = range ? `${range}` : '';
      destDetail.textContent = meta.destination || '‚Äî';

      // Tabs + sections
      const { keys, buckets } = groupByDay(items);
      dayTrack.innerHTML = '';
      daysRoot.innerHTML = '';

      if (keys.length) dayTabs.classList.remove('hidden');
      keys.forEach((k, i) => {
        const label = k === 'undated' ? 'Any day' : fmtDate(k);
        // tab
        const a = document.createElement('a');
        a.className = 'day-pill' + (i===0 ? ' active' : '');
        a.href = `#day-${i+1}`;
        a.textContent = label;
        dayTrack.appendChild(a);

        // section
        const sec = document.createElement('section');
        sec.id = `day-${i+1}`;
        sec.className = 'day-section';
        sec.innerHTML = `
          <div class="day-header">
            <h2 class="day-title">${label}</h2>
            <span class="day-date"></span>
          </div>
          <div class="stops"></div>
        `;
        const stopWrap = sec.querySelector('.stops');

        const itemsForDay = buckets.get(k).slice().sort((a,b)=>{
          const ta = a.planned_time || '99:99';
          const tb = b.planned_time || '99:99';
          return ta.localeCompare(tb);
        });

        itemsForDay.forEach(item => {
          const cat = (item.category||'').toLowerCase();
          const badge = cat ? `<span class="badge ${cat}">${cat.toUpperCase()}</span>` : '';
          const cover = item.image ? `style="background-image:url('${item.image}')"` : '';
          const place = document.createElement('article');
          place.className = 'stop-card';
          place.innerHTML = `
            <div class="stop-cover" ${cover}>
              ${item.planned_time ? `<span class="time-badge">${item.planned_time}</span>` : ''}
            </div>
            <div class="stop-body">
              <div class="stop-top">
                <h3 class="stop-name">${item.name || 'Place'}</h3>
                ${badge}
              </div>
              <div class="stop-meta"><span>${item.town || item.parish || item.location || ''}</span></div>
              <div class="stop-actions">
                ${item.slug ? `<a class="btn-mini" href="/listing/${encodeURIComponent(item.slug)}">View</a>` : ''}
                <a class="btn-mini" target="_blank" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.name + ' ' + (item.town||''))}">Directions</a>
              </div>
            </div>`;
          stopWrap.appendChild(place);
        });

        daysRoot.appendChild(sec);
      });

      // Tab active state
      const tabs = Array.from(document.querySelectorAll('.day-pill'));
      const sections = tabs.map(t => document.querySelector(t.getAttribute('href'))).filter(Boolean);
      const onScroll = () => {
        const y = window.scrollY + 140;
        let activeIndex = 0;
        sections.forEach((sec,i)=>{ if(sec.offsetTop <= y) activeIndex = i; });
        tabs.forEach((t,i)=> t.classList.toggle('active', i===activeIndex));
      };
      document.addEventListener('scroll', onScroll, {passive:true});
      onScroll();
    }

    async function main(){
      const token = parseTokenFromPath();
      if (!token){
        errorBox.classList.remove('hidden');
        titleEl.textContent = 'Invalid link';
        if (errorDetail) errorDetail.textContent = 'No token found in URL path. Expected /itinerary/<token>.';
        return;
      }
      try{
        let data, error;
        // 1) Try token as-is
        ({ data, error } = await supa.rpc('get_shared_itinerary', { _token: token }));
        debug('RPC get_shared_itinerary', { hasData: !!data, hasError: !!error, token });

        // 2) Retry with dashless token if not found
        if ((!data || error) && token.includes('-')) {
          const tokenNoDash = token.replace(/-/g, '');
          debug('Retry with dashless token', tokenNoDash);
          const retry = await supa.rpc('get_shared_itinerary', { _token: tokenNoDash });
          data = retry.data; error = retry.error;
          debug('Retry result', { hasData: !!data, hasError: !!error });
        }

        // 3) If still nothing and it looks like an itinerary UUID, try by itinerary_id via a separate RPC
        if ((!data || error) && isUuid(token)) {
          debug('Token looked like itinerary_id, trying get_shared_itinerary_by_id');
          const byId = await supa.rpc('get_shared_itinerary_by_id', { _itinerary_id: token });
          data = byId.data; error = byId.error;
          debug('ById result', { hasData: !!data, hasError: !!error });
        }

        if (error || !data){ throw error || new Error('Not found'); }
        render(data.items || [], data);
        // Bump views (ignore errors)
        supa.rpc('bump_share_view', { _token: token }).catch(()=>{});
        // Wire buttons
        if (copyBtn){
          copyBtn.addEventListener('click', async () => {
            try{ await navigator.clipboard.writeText(location.href); copyBtn.textContent='Copied!'; setTimeout(()=>copyBtn.textContent='Copy Link', 1600);}catch(e){ alert('Copy failed'); }
          });
        }
        if (saveBtn){
          saveBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const deep = `troddrapp://import/shared_itinerary?token=${encodeURIComponent(token)}`;
            // Try deep link; if it fails, fall back stays on page
            window.location.href = deep;
          });
        }
      }catch(e){
        console.error('[itinerary] load error', e);
        errorBox.classList.remove('hidden');
        titleEl.textContent = 'Itinerary unavailable';
        if (errorDetail) errorDetail.textContent = (e && e.message) ? e.message : 'Failed to fetch from Supabase. Check env vars and RPC permissions.';
      }
    }

    main();
  </script>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="TRODDR - Jamaica-first travel guide and trip planner. Discover where to eat, stay, and play like a local. Get authentic Caribbean travel experiences.">
    <meta name="keywords" content="Jamaica travel, Caribbean guide, local experiences, trip planner, authentic travel, Jamaica restaurants, local attractions">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="TRODDR - Experience Jamaica Like a Local">
    <meta property="og:description" content="Discover authentic Caribbean experiences with local recommendations for where to eat, stay, and play in Jamaica.">
    <meta property="og:image" content="https://troddr.com/images/og-image.jpg">
    <meta property="og:url" content="https://troddr.com">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="TRODDR - Experience Jamaica Like a Local">
    <meta name="twitter:description" content="Discover authentic Caribbean experiences with local recommendations for where to eat, stay, and play in Jamaica.">
    <meta name="twitter:image" content="https://troddr.com/images/twitter-image.jpg">
    
    <title>TRODDR - Experience Jamaica Like a Local | Authentic Caribbean Travel</title>

    <!-- Preload critical resources -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" as="style">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="images/troddr_logo.png">
    <link rel="icon" type="image/png" href="images/troddr_logo.png">
    <link rel="apple-touch-icon" href="images/troddr_logo.png">
    
    <!-- Stylesheets -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N0L5H68MFR"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-N0L5H68MFR');
    </script>

    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "TRODDR",
        "description": "Jamaica-first travel guide and trip planner for authentic Caribbean experiences",
        "url": "https://troddr.com",
        "applicationCategory": "TravelApplication",
        "operatingSystem": "iOS, Android, Web",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "publisher": {
            "@type": "Organization",
            "name": "TRODDR Ltd",
            "url": "https://troddr.com"
        }
    }
    </script>
  <style>
    :root{
      --primary: #0077cc;
      --primary-dark:#005da1;
      --primary-light:#3aa0ff;
      --dark:#0f172a;
      --gray:#6b7280;
      --light:#f8fafc;
      --card:#ffffff;
      --green:#10b981;
      --amber:#f59e0b;
      --rose:#ef4444;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fff;color:var(--dark)}

    /* Dark background option */
    .dark-bg { background: #1e293b !important; color: #f8fafc !important; }

    .hidden{display:none}
    .error{max-width:900px;margin:40px auto;padding:20px;border:1px solid #fee2e2;background:#fef2f2;color:#991b1b;border-radius:12px}

    /* Header */
    .itinerary-header{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid #eef2f7}
    .itinerary-header .bar{max-width:1200px;margin:0 auto;padding:14px 20px;display:flex;align-items:center;gap:16px}
    .logo{font-weight:800;letter-spacing:.5px}
    .logo a{color:var(--dark);text-decoration:none}
    .trip-meta{display:flex;flex-wrap:wrap;gap:12px;margin-left:auto;align-items:center}
    .meta-pill{background:var(--light);border:1px solid #eef2f7;border-radius:999px;padding:6px 12px;font-size:.9rem;color:#334155}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:999px;border:1px solid #e5e7eb;background:#fff;color:var(--dark);padding:.6rem 1rem;font-weight:600;text-decoration:none;cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff;border-color:transparent;box-shadow:0 8px 18px rgba(0,119,204,.25)}
    .btn-primary:hover{background:var(--primary-dark)}

    /* Hero summary */
    .trip-hero{max-width:1200px;margin:0 auto;padding:22px 20px 10px;display:grid;grid-template-columns:1fr auto;gap:14px;align-items:center}
    .trip-title{font-size:1.6rem;margin:0}
    .trip-sub{color:var(--gray);margin:.25rem 0 0}

    /* Tabs for days */
    .day-tabs{position:sticky;top:60px;z-index:40;background:#fff;border-bottom:1px solid #eef2f7}
    .day-track{max-width:1200px;margin:0 auto;padding:10px 20px;display:flex;gap:8px;overflow:auto}
    .day-pill{padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;color:#0f172a;font-weight:600;white-space:nowrap;cursor:pointer}
    .day-pill.active,.day-pill:hover{background:var(--primary);color:#fff;border-color:transparent}

    /* Layout */
    .page{max-width:1200px;margin:0 auto;padding:18px 20px 40px;display:grid;grid-template-columns: 1fr;gap:18px}

    /* Day section */
    .day-section{scroll-margin-top:120px}
    .day-header{display:flex;align-items:baseline;gap:10px;margin:18px 0 10px}
    .day-title{font-size:1.25rem;margin:0}
    .day-date{color:var(--gray)}

    /* Stop cards */
    .stops{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
    .stop-card{background:var(--card);border:1px solid #eef2f7;border-radius:14px;overflow:hidden;box-shadow:0 8px 18px rgba(15,23,42,.04)}
    .stop-cover{height:130px;background:#e2e8f0;background-position:center;background-size:cover}
    .stop-body{padding:12px 14px}
    .stop-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .stop-name{margin:0;font-size:1.05rem}
    .badge{padding:4px 8px;border-radius:999px;font-size:.75rem;font-weight:700}
    .badge.eat{background:#fff7ed;border:1px solid #fed7aa;color:#c2410c}
    .badge.play{background:#ecfeff;border:1px solid #a5f3fc;color:#155e75}
    .badge.stay{background:#f0f9ff;border:1px solid #bae6fd;color:#075985}
    .stop-meta{display:flex;gap:10px;color:var(--gray);font-size:.9rem;margin:8px 0}
    .stop-actions{display:flex;gap:8px}
    .btn-mini{padding:.45rem .7rem;border-radius:10px;border:1px solid #e5e7eb;background:#fff;color:#0f172a;font-weight:600;text-decoration:none}
    .btn-mini:hover{border-color:#cbd5e1}

    /* Map placeholder */
    .map-wrap{border:1px dashed #cbd5e1;border-radius:14px;height:220px;display:flex;align-items:center;justify-content:center;color:#64748b}

    @media (min-width: 1000px){
      .page{grid-template-columns: 320px 1fr;align-items:start}
      .sidebar{position:sticky;top:116px}
    }

    /* --- Polish --------------------------------------------------------- */
    .container{max-width:1200px;margin:0 auto;padding:0 20px}
    .itinerary-header{backdrop-filter:saturate(1.2) blur(6px);background:rgba(255,255,255,.85)}
    .itinerary-header .bar{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:12px 20px}
    .itinerary-header .logo{font-weight:800;letter-spacing:.5px;font-size:1.05rem;color:var(--dark);text-decoration:none}

    .trip-hero{border-bottom:1px solid #eef2f7}
    .trip-title{font-size:2rem;letter-spacing:-.2px}
    .trip-sub{font-size:1rem}

    .map-wrap{background:linear-gradient(180deg,#f8fbff 0%,#eef6ff 100%);border:1px solid #e6eef9}

    .day-tabs{box-shadow:0 6px 16px rgba(15,23,42,.04)}
    .day-pill{transition:all .15s ease}

    .stop-card{transition:box-shadow .2s ease,transform .2s ease}
    .stop-card:hover{transform:translateY(-2px);box-shadow:0 12px 26px rgba(15,23,42,.08)}
    .stop-cover{position:relative}
    .time-badge{position:absolute;left:10px;top:10px;background:rgba(0,0,0,.65);color:#fff;padding:4px 8px;border-radius:999px;font-size:.75rem;font-weight:700}

    .btn{transition:transform .08s ease, box-shadow .2s ease}
    .btn:active{transform:translateY(1px)}

    /* Better spacing for main grid */
    @media (min-width:1000px){
      .page{gap:24px}
    }

    /* --- Dark mode ------------------------------------------------------ */
    @media (prefers-color-scheme: dark){
      html,body{background:#0b1220;color:#e5e7eb}
      .itinerary-header{background:rgba(15,23,42,.7)}
      .itinerary-header .logo{color:#e5e7eb}
      .meta-pill{background:#0f172a;border-color:#1f2937;color:#cbd5e1}
      .day-tabs{background:#0b1220;border-color:#1f2937}
      .day-pill{background:#0f172a;border-color:#1f2937;color:#e5e7eb}
      .day-pill.active,.day-pill:hover{background:var(--primary);color:#fff}
      .stop-card{background:#0f172a;border-color:#1f2937;box-shadow:0 8px 18px rgba(0,0,0,.25)}
      .stop-meta{color:#9ca3af}
      .btn{background:#0f172a;color:#e5e7eb;border-color:#1f2937}
      .btn-primary{background:var(--primary)}
      .map-wrap{background:linear-gradient(180deg,#0f172a,#0b1220);border-color:#1f2937;color:#9ca3af}
      .error{background:#2b1d1d;border-color:#7f1d1d;color:#fecaca}
    }
  </style>
</head>
<body>
  <!-- Header -->

    <header class="header" role="banner">
      <div class="navbar">
          <a href="index.html" class="logo" aria-label="TRODDR - Home">troddr</a>
          <!-- <button class="mobile-menu-btn" aria-label="Toggle navigation menu" aria-expanded="false">
              ☰
          </button> -->
          <button class="mobile-menu-btn"
                  aria-controls="primary-navigation"
                  aria-expanded="false"
                  aria-label="Open menu">
                  <span aria-hidden="true">☰</span>
          </button>
          <div class="nav-links" id="primary-navigation" role="navigation">
              <button class="nav-close-btn" aria-controls="primary-navigation" aria-label="Close menu">×</button>
              <a href="about.html" class="nav-item">About</a>
              <a href="#features" class="nav-item">Features</a>
              <a href="contact.html" class="nav-item">Contact</a>
              <a href="#waitlist" class="nav-cta">Join Waitlist</a>
          </div>
      </div>
  </header>
  <header class="itinerary-header">
    <div class="bar">
      <a href="/index.html" class="logo">troddr</a>
      <div class="trip-meta">
        <span class="meta-pill" id="meta-destination">—</span>
        <span class="meta-pill" id="meta-dates"></span>
        <button class="btn" id="btn-copy">Copy Link</button>
        <a class="btn btn-primary" href="troddrapp://import/shared_itinerary?token=<TOKEN>" id="btn-save">Open in App</a>
      </div>
    </div>
  </header>

  <!-- Summary hero (dynamic) -->
  <section class="trip-hero">
    <div>
      <h1 class="trip-title" id="trip-title">Loading…</h1>
      <p class="trip-sub" id="trip-sub"></p>
    </div>
    <div class="map-wrap" id="map-preview">Map preview</div>
  </section>

  <!-- Day tabs (dynamic) -->
  <nav class="day-tabs hidden" id="day-tabs">
    <div class="day-track" id="day-track"></div>
  </nav>

  <!-- Page layout: sidebar + content (dynamic) -->
  <main class="page">
    <aside class="sidebar">
      <div class="stop-card" style="padding:14px">
        <h3 style="margin:6px 0 4px">Trip Details</h3>
        <div class="stop-meta"><span id="detail-createdby">👤 Shared itinerary</span></div>
        <div class="stop-meta"><span id="detail-base">📍 Destination: <span id="detail-destination">—</span></span></div>
      </div>
      <div style="height:14px"></div>
      <div class="stop-card" style="padding:14px">
        <h3 style="margin:6px 0 10px">Quick Actions</h3>
        <div class="stop-actions">
          <a class="btn-mini" href="#" id="qa-open-maps">Open in Maps</a>
        </div>
      </div>
      <div id="error-box" class="error hidden">
        <div style="font-weight:700;margin-bottom:6px">Unable to load itinerary.</div>
        <div id="error-detail">The link may be invalid or expired.</div>
      </div>
    </aside>

    <section id="days-root"></section>
  </main>

  <!-- Public env for static hosting: safe to expose anon key (RLS protects data) -->
  <script>
    window.env = {
      SUPABASE_URL: 'https://rprpwudhplodaqmmwqkf.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwcnB3dWRocGxvZGFxbW13cWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAyODcyODksImV4cCI6MjA2NTg2MzI4OX0.lNL6YZQqZgbsQRJyRAXpaWMC4LxncvPPyXNP1qopTFk'
    };
  </script>
  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = window.env?.SUPABASE_URL || 'https://YOUR_SUPABASE_PROJECT.supabase.co';
    const SUPABASE_ANON_KEY = window.env?.SUPABASE_ANON_KEY || 'YOUR_PUBLIC_ANON_KEY';
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } });

    // ====== DOM HOOKS ======
    const $ = (sel) => document.querySelector(sel);
    const dayTabs = $('#day-tabs');
    const dayTrack = $('#day-track');
    const daysRoot = $('#days-root');
    const titleEl = $('#trip-title');
    const subEl = $('#trip-sub');
    const destMeta = $('#meta-destination');
    const datesMeta = $('#meta-dates');
    const destDetail = $('#detail-destination');
    const copyBtn = $('#btn-copy');
    const saveBtn = $('#btn-save');
    const errorBox = $('#error-box');
    const errorDetail = $('#error-detail');
    const debug = (...args) => { try { console.debug('[itinerary]', ...args); } catch {} };
    debug('ENV', { url: SUPABASE_URL && 'ok', anon: SUPABASE_ANON_KEY ? 'set' : 'missing' });

    // ====== UTIL ======
    const fmtDate = (iso) => {
      if (!iso) return '';
      try { return new Date(iso).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' }); } catch { return iso; }
    };
    const fmtRange = (s, e) => s && e ? `${fmtDate(s)} – ${fmtDate(e)}` : (s || e ? (fmtDate(s||e)) : '');

    const parseTokenFromPath = () => {
      // Expect /itinerary/<token>
      const parts = (location.pathname || '').split('/').filter(Boolean);
      const idx = parts.findIndex(p => p.toLowerCase() === 'itinerary');
      return idx >= 0 ? parts[idx+1] : null;
    };

    const groupByDay = (items=[]) => {
      const buckets = new Map();
      items.forEach(it => {
        const k = it.planned_day || 'undated';
        if (!buckets.has(k)) buckets.set(k, []);
        buckets.get(k).push(it);
      });
      // sort dated keys asc, undated last
      const keys = Array.from(buckets.keys()).sort((a,b) => {
        if (a==='undated') return 1; if (b==='undated') return -1;
        return new Date(a) - new Date(b);
      });
      return { keys, buckets };
    };

    function render(items, meta){
      // Header/meta
      titleEl.textContent = meta.title || 'Itinerary';
      subEl.textContent = meta.destination ? `Around ${meta.destination}` : '';
      destMeta.textContent = meta.destination || '—';
      const range = fmtRange(meta.start_date, meta.end_date);
      datesMeta.textContent = range ? `${range}` : '';
      destDetail.textContent = meta.destination || '—';

      // Tabs + sections
      const { keys, buckets } = groupByDay(items);
      dayTrack.innerHTML = '';
      daysRoot.innerHTML = '';

      if (keys.length) dayTabs.classList.remove('hidden');
      keys.forEach((k, i) => {
        const label = k === 'undated' ? 'Any day' : fmtDate(k);
        // tab
        const a = document.createElement('a');
        a.className = 'day-pill' + (i===0 ? ' active' : '');
        a.href = `#day-${i+1}`;
        a.textContent = label;
        dayTrack.appendChild(a);

        // section
        const sec = document.createElement('section');
        sec.id = `day-${i+1}`;
        sec.className = 'day-section';
        sec.innerHTML = `
          <div class="day-header">
            <h2 class="day-title">${label}</h2>
            <span class="day-date"></span>
          </div>
          <div class="stops"></div>
        `;
        const stopWrap = sec.querySelector('.stops');

        const itemsForDay = buckets.get(k).slice().sort((a,b)=>{
          const ta = a.planned_time || '99:99';
          const tb = b.planned_time || '99:99';
          return ta.localeCompare(tb);
        });

        itemsForDay.forEach(item => {
          const cat = (item.category||'').toLowerCase();
          const badge = cat ? `<span class="badge ${cat}">${cat.toUpperCase()}</span>` : '';
          const cover = item.image ? `style="background-image:url('${item.image}')"` : '';
          const place = document.createElement('article');
          place.className = 'stop-card';
          place.innerHTML = `
            <div class="stop-cover" ${cover}>
              ${item.planned_time ? `<span class="time-badge">${item.planned_time}</span>` : ''}
            </div>
            <div class="stop-body">
              <div class="stop-top">
                <h3 class="stop-name">${item.name || 'Place'}</h3>
                ${badge}
              </div>
              <div class="stop-meta"><span>${item.town || item.parish || item.location || ''}</span></div>
              <div class="stop-actions">
                ${item.slug ? `<a class="btn-mini" href="/listing/${encodeURIComponent(item.slug)}">View</a>` : ''}
                <a class="btn-mini" target="_blank" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.name + ' ' + (item.town||''))}">Directions</a>
              </div>
            </div>`;
          stopWrap.appendChild(place);
        });

        daysRoot.appendChild(sec);
      });

      // Tab active state
      const tabs = Array.from(document.querySelectorAll('.day-pill'));
      const sections = tabs.map(t => document.querySelector(t.getAttribute('href'))).filter(Boolean);
      const onScroll = () => {
        const y = window.scrollY + 140;
        let activeIndex = 0;
        sections.forEach((sec,i)=>{ if(sec.offsetTop <= y) activeIndex = i; });
        tabs.forEach((t,i)=> t.classList.toggle('active', i===activeIndex));
      };
      document.addEventListener('scroll', onScroll, {passive:true});
      onScroll();
    }

    async function main(){
      const token = parseTokenFromPath();
      if (!token){
        errorBox.classList.remove('hidden');
        titleEl.textContent = 'Invalid link';
        if (errorDetail) errorDetail.textContent = 'No token found in URL path. Expected /itinerary/<token>.';
        return;
      }
      try{
        let { data, error } = await supa.rpc('get_shared_itinerary', { _token: token });
        debug('RPC get_shared_itinerary', { hasData: !!data, hasError: !!error, token });

        if ((!data || error) && token.includes('-')) {
          const tokenNoDash = token.replace(/-/g, '');
          debug('Retry with dashless token', tokenNoDash);
          const retry = await supa.rpc('get_shared_itinerary', { _token: tokenNoDash });
          data = retry.data; error = retry.error;
          debug('Retry result', { hasData: !!data, hasError: !!error });
        }

        if (error || !data){ throw error || new Error('Not found'); }
        render(data.items || [], data);
        // Bump views (ignore errors)
        supa.rpc('bump_share_view', { _token: token }).catch(()=>{});
        // Wire buttons
        if (copyBtn){
          copyBtn.addEventListener('click', async () => {
            try{ await navigator.clipboard.writeText(location.href); copyBtn.textContent='Copied!'; setTimeout(()=>copyBtn.textContent='Copy Link', 1600);}catch(e){ alert('Copy failed'); }
          });
        }
        if (saveBtn){
          saveBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const deep = `troddrapp://import/shared_itinerary?token=${encodeURIComponent(token)}`;
            // Try deep link; if it fails, fall back stays on page
            window.location.href = deep;
          });
        }
      }catch(e){
        console.error('[itinerary] load error', e);
        errorBox.classList.remove('hidden');
        titleEl.textContent = 'Itinerary unavailable';
        if (errorDetail) errorDetail.textContent = (e && e.message) ? e.message : 'Failed to fetch from Supabase. Check env vars and RPC permissions.';
      }
    }

    main();
  </script>
</body>
</html>
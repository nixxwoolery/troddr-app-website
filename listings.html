<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TRODDR — Listing</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#0077cc; --bg:#ffffff; --fg:#0b1220; --muted:#6b7280; --card:#f7f7fb;
      --radius:14px; --gap:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    a{text-decoration:none;color:inherit}

    .wrap{max-width:1100px;margin:0 auto;padding:20px}

    /* HERO — 3-panel collage like your app detail screen */
    .hero{display:grid;grid-template-columns:1.05fr 1.2fr 0.9fr;gap:var(--gap);height:min(65vh,720px);margin-top:8px}
    .hero .col{position:relative;border-radius:var(--radius);overflow:hidden;background:#e9ecef}
    .hero img{width:100%;height:100%;object-fit:cover;display:block}
    .hero .count{position:absolute;right:12px;bottom:12px;background:#fff;border-radius:10px;padding:6px 10px;font-weight:700;box-shadow:0 6px 18px rgba(0,0,0,.15);}

    /* Title row */
    header.page{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:14px 0 10px}
    .titleBlock{min-width:0}
    .title{font-size:clamp(22px,3.2vw,36px);font-weight:800;margin:0 0 4px}
    .sub{color:var(--muted);font-size:14px}
    .cta{display:inline-flex;align-items:center;gap:10px;background:var(--brand);color:#fff;border-radius:12px;padding:10px 14px;font-weight:700}

    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:var(--radius);padding:16px}
    .grid{display:grid;gap:16px;grid-template-columns:1fr 1fr}

    @media (max-width: 900px){
      .hero{grid-template-columns:1fr;height:auto}
      .hero .col{height:42vh}
      .grid{grid-template-columns:1fr}
    }
  </style>
  <script>
    window.env = {
      SUPABASE_URL: 'https://rprpwudhplodaqmmwqkf.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwcnB3dWRocGxvZGFxbW13cWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAyODcyODksImV4cCI6MjA2NTg2MzI4OX0.lNL6YZQqZgbsQRJyRAXpaWMC4LxncvPPyXNP1qopTFk'
    };
  </script>
</head>
<body>
  <div class="wrap">
    <header class="page">
      <div class="titleBlock">
        <h1 class="title" id="listing-title">Loading…</h1>
        <div class="sub" id="listing-sub">—</div>
      </div>
      <a class="cta" id="open-in-app" href="#">Open in App</a>
    </header>

    <!-- Collage hero (3 images) -->
    <section class="hero" id="hero">
      <div class="col"><img id="img1" alt="" /><div class="count" id="countBadge">3</div></div>
      <div class="col"><img id="img2" alt="" /></div>
      <div class="col"><img id="img3" alt="" /></div>
    </section>

    <div style="height:18px"></div>

    <section class="grid">
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a class="cta" id="action-directions" href="#">Directions</a>
        <a class="cta" id="action-website" href="#">Website</a>
        <a class="cta" id="action-menu" href="#">Menu</a>
        <a class="cta" id="action-call" href="#">Call</a>
      </div>
      <div class="card">
        <div class="sub" style="margin-bottom:6px">Overview</div>
        <div id="overview" style="margin:6px 0 10px 0;color:#0b1220"></div>
        <div id="details" style="margin-top:12px"></div>
      </div>
    </section>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    function showLoadError(msg) {
      const el = document.getElementById('overview');
      if (el) el.textContent = msg || "We couldn't load this listing right now.";
    }
  
    // Resolve slug from ?slug=… or /listings/<slug>
    const params = new URLSearchParams(location.search);
    const pathMatch = location.pathname.match(/\/listings\/([^\/?#]+)/i);
    const slug = params.get('slug') || (pathMatch ? decodeURIComponent(pathMatch[1]) : '');
  
    // Supabase client (same values you used in itinerary.html)
    const SUPABASE_URL = (window.env?.SUPABASE_URL || window.SUPABASE_URL || '').trim();
const SUPABASE_ANON_KEY = (window.env?.SUPABASE_ANON_KEY || window.SUPABASE_ANON_KEY || '').trim();
const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } });
  
    const $ = (sel) => document.querySelector(sel);
    const set = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text ?? ''; };
    const asList = (v) => {
      if (v == null) return '';
      if (Array.isArray(v)) return v.filter(Boolean).join(', ');
      if (typeof v === 'object') {
        try {
          // json/jsonb -> join values
          const arr = Array.isArray(v) ? v : Object.values(v);
          return arr.filter(Boolean).join(', ');
        } catch {}
      }
      const s = String(v);
      if (!s) return '';
      // handle text[] serialized as JSON string
      try { const parsed = JSON.parse(s); if (Array.isArray(parsed)) return parsed.filter(Boolean).join(', '); } catch {}
      return s;
    };
  
    // Robustly normalize your `image` column (jsonb array, text[], or string)
    const normalizeImages = (img) => {
      try {
        if (Array.isArray(img)) return img.filter(Boolean);
        if (typeof img === 'string') {
          const s = img.trim();
          if (!s) return [];
          if (s.startsWith('[')) { const a = JSON.parse(s); return Array.isArray(a) ? a.filter(Boolean) : []; }
          return [s];
        }
        if (img && typeof img === 'object') {
          const a = JSON.parse(JSON.stringify(img));
          return Array.isArray(a) ? a.filter(Boolean) : [];
        }
      } catch {}
      return [];
    };
  
    const titleCaseSlug = (str) => (str || '').replace(/-/g,' ').replace(/\b\w/g, s => s.toUpperCase());
  
    async function main(){
      if (!slug) { set('listing-title','Listing'); set('listing-sub',''); return; }
  
      // Default header while loading
      set('listing-title', titleCaseSlug(slug));
      set('listing-sub', 'Web view');
      const openInApp = document.getElementById('open-in-app');
      if (openInApp) openInApp.href = 'troddrapp://listing/' + encodeURIComponent(slug);
  
      // Fetch the listing
      async function fetchPlaceBySlug(slug) {
        // 1) Try direct table read
        const sel = await supa
          .from('places')
          .select('*')
          .eq('slug', slug)
          .maybeSingle();

        if (sel.data) return { data: sel.data };

        // 2) Fallback: RPCs that can be SECURITY DEFINER in DB
        const tryRPC = async (fn) => {
          try {
            const r = await supa.rpc(fn, { _slug: slug });
            if (!r.error && r.data) return { data: r.data };
            return { error: r.error || new Error('No data from ' + fn) };
          } catch (e) {
            return { error: e };
          }
        };

        // Try either function name—use whichever you created in the DB
        const viaPublic = await tryRPC('get_place_public');
        if (viaPublic.data) return viaPublic;

        const viaBySlug = await tryRPC('get_place_by_slug');
        if (viaBySlug.data) return viaBySlug;

        return { error: sel.error || viaPublic.error || viaBySlug.error || new Error('Not found') };
      }

      // Fetch with fallbacks
      const { data: place, error } = await fetchPlaceBySlug(slug);

      if (error || !place) {
        console.warn('Listing load failed:', error?.message || error || 'no data');
        showLoadError("We couldn't load this listing right now.");
        return;
      }
  
      // Header/subtitle
      set('listing-title', place.name || titleCaseSlug(slug));
      const locStr = [place.town, place.parish].filter(Boolean).join(', ');
      set('listing-sub', locStr || '');
  
      // Overview
      $('#overview').textContent = place.description || '—';
  
      // Details (simple key:value)
      const details = [
        ['Type', place.type],
        ['Category', place.category],
        ['Meal Service', place.meal_type || place.meal_service],
        ['Cuisine', asList(place.cuisine)],
        ['Price Range', place.price_range || place.price],
        ['Ambiance', asList(place.ambiance)],
        ['Activities', asList(place.activities)],
        ['Perfect For', asList(place.perfect_for)],
        ['Number of Rooms', place.number_of_rooms],
        ['Amenities', asList(place.amenities)],
        ['Room Types', asList(place.room_types)],
        ['Opening Hours', place.opening_hours || place.hours],
        ['Address', [place.address, [place.town, place.parish].filter(Boolean).join(', ')].filter(Boolean).join(', ')],
        ['Phone', place.phone_number || place.phone],
        ['Website', place.website],
        ['Menu', place.menu_link],
      ].filter(([,v]) => v && String(v).trim() !== '');

      const detailsEl = document.getElementById('details');
      if (detailsEl) {
        if (details.length) {
          detailsEl.innerHTML = details.map(([k, v]) => {
            if (k === 'Website' && v) return `<div style="display:flex;gap:8px;margin:6px 0"><strong style="min-width:140px">${k}:</strong> <a href="${v}" target="_blank" rel="noopener">${v}</a></div>`;
            if (k === 'Menu' && v) return `<div style="display:flex;gap:8px;margin:6px 0"><strong style="min-width:140px">${k}:</strong> <a href="${v}" target="_blank" rel="noopener">View Menu</a></div>`;
            if (k === 'Phone' && v) return `<div style="display:flex;gap:8px;margin:6px 0"><strong style="min-width:140px">${k}:</strong> <a href="tel:${v}">${v}</a></div>`;
            return `<div style="display:flex;gap:8px;margin:6px 0"><strong style="min-width:140px">${k}:</strong> <span>${asList(v)}</span></div>`;
          }).join('');
        } else {
          detailsEl.textContent = '';
        }
      }
  
      // Hero images (3 panels)
      const provided = [params.get('img1'), params.get('img2'), params.get('img3')].filter(Boolean);
      let imgs = provided.length ? provided : normalizeImages(place.image);
      if (!imgs.length) {
        imgs = [
          'https://images.unsplash.com/photo-1526318472351-c75fcf070305?w=1400&q=80&auto=format&fit=crop',
          'https://images.unsplash.com/photo-1512058564366-18510be2db19?w=1600&q=80&auto=format&fit=crop',
          'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=1200&q=80&auto=format&fit=crop'
        ];
      }
      while (imgs.length < 3) imgs.push(imgs[imgs.length - 1]);
      ['img1','img2','img3'].forEach((id, i) => {
        const el = document.getElementById(id);
        if (el) { el.src = imgs[i]; el.alt = place.name; }
      });
      const countBadge = document.getElementById('countBadge');
      if (countBadge) countBadge.textContent = String(normalizeImages(place.image).length || imgs.length);
  
      // Quick actions
      const dirA = document.getElementById('action-directions');
      if (dirA) {
        let mapsUrl = '';
        if (Number.isFinite(Number(place.latitude)) && Number.isFinite(Number(place.longitude))) {
          mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(`${place.latitude},${place.longitude}`)}`;
        } else {
          const q = [place.name, place.address, [place.town, place.parish].filter(Boolean).join(', ')].filter(Boolean).join(', ');
          mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;
        }
        dirA.href = mapsUrl;
      }

      const webA = document.getElementById('action-website');
      if (webA) { if (place.website) webA.href = place.website; else webA.style.display = 'none'; }

      const menuA = document.getElementById('action-menu');
      if (menuA) { if (place.menu_link) menuA.href = place.menu_link; else menuA.style.display = 'none'; }

      const callA = document.getElementById('action-call');
      if (callA) { if (place.phone_number || place.phone) callA.href = 'tel:' + (place.phone_number || place.phone); else callA.style.display = 'none'; }
    }
  
    main();
  </script>
</body>
</html>